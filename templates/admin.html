<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Console</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/dashboard.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 50%, #dee2e6 100%);
      min-height: 100vh;
      transition: background 0.3s ease;
    }
    
    body.dark-mode {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    }
    
    /* Header Styles */
    .admin-header {
      background: white;
      border-radius: 20px;
      padding: 28px 32px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin-bottom: 24px;
      transition: all 0.3s ease;
    }
    
    body.dark-mode .admin-header {
      background: #1e293b;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .page-title {
      font-size: 36px;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      line-height: 1.2;
    }
    
    .page-subtitle {
      color: #6b7280;
      font-size: 15px;
      font-weight: 500;
      margin-top: 6px;
    }
    
    body.dark-mode .page-subtitle {
      color: #94a3b8;
    }
    
    /* Card Styles */
    .admin-card {
      background: white;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 600px;
    }

    .admin-card.tx-card-loading {
      min-height: 300px !important;
      max-height: 300px !important;
    }

    .admin-card.tx-card-loaded {
      min-height: 600px !important;
      max-height: none !important;
    }
    
    body.dark-mode .admin-card {
      background: #1e293b;
      border-color: #334155;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* Quick Action card - scrollable content, fixed height */
    .admin-card.quick-action-card {
      overflow: hidden;
      display: flex;
      flex-direction: column;
      
    }
    
    .admin-card.quick-action-card > .card-title {
      flex-shrink: 0;
      margin-top:32px;
      margin-bottom: 32px;
    }
    
    .admin-card.quick-action-card .form-label-modern:first-of-type {
      flex-shrink: 0;
    }
    
    .admin-card.quick-action-card .input-modern {
      flex-shrink: 0;
    }
    
    .admin-card.quick-action-card .btn-blue-modern {
      flex-shrink: 0;
    }
    
    /* Scrollable content area */
    .quick-action-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 8px;
    }
    
    .quick-action-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .quick-action-content::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .quick-action-content::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }
    
    .quick-action-content::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .admin-card.quick-action-card .action-section {
      flex-shrink: 0;
      margin-top: auto;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 900;
      color: #050a16;
      margin-bottom: 32px;
      letter-spacing: 0px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    body.dark-mode .card-title {
      color: #e2e8f0;
      border-bottom-color: #334155;
    }
    
    /* Card section headers with text-lg font-bold */
    .admin-card h3.text-lg {
      font-size: 16px;
      font-weight: 900;
      color: #323f5c;
      margin-bottom: 8px;
      letter-spacing: 0px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    body.dark-mode .admin-card h3.text-lg {
      color: #92a2b7;
      border-bottom-color: #334155;
    }
    
    /* Form Elements */
    .form-label-modern {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      letter-spacing: 0.3px;
    }
    
    body.dark-mode .form-label-modern {
      color: #cbd5e1;
    }
    
    .input-modern {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
      color: #1f2937;
    }
    
    .input-modern:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .input-modern:hover:not(:focus) {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.08);
    }
    
    body.dark-mode .input-modern {
      background: #334155;
      border-color: #475569;
      color: #f1f5f9;
    }
    
    body.dark-mode .input-modern:focus {
      border-color: #818cf8;
      box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.2);
    }

    body.dark-mode .input-modern:hover:not(:focus) {
      border-color: #818cf8;
      box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.15);
    }
    
    select.input-modern {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 40px;
    }

    body.dark-mode select.input-modern {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23e2e8f0'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
    }
    
    /* Buttons */
    .btn-modern {
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    .btn-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
      z-index: 1;
    }
    
    .btn-modern:hover::before {
      left: 100%;
    }
    
    .btn-modern:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .btn-modern:active {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary-modern {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .btn-primary-modern:hover {
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .btn-blue-modern {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .btn-blue-modern:hover {
      box-shadow: 0 12px 28px rgba(59, 130, 246, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .btn-green-modern {
      background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .btn-green-modern:hover {
      box-shadow: 0 12px 28px rgba(16, 185, 129, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .btn-red-modern {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .btn-red-modern:hover {
      box-shadow: 0 12px 28px rgba(239, 68, 68, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .btn-modern:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    /* Dark mode button visibility fixes */
    body.dark-mode .btn-primary-modern {
      background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #d946ef 100%);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    body.dark-mode .btn-primary-modern:hover {
      box-shadow: 0 12px 28px rgba(139, 92, 246, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    body.dark-mode .btn-blue-modern {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 50%, #2563eb 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    body.dark-mode .btn-blue-modern:hover {
      box-shadow: 0 12px 28px rgba(96, 165, 250, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    body.dark-mode .btn-green-modern {
      background: linear-gradient(135deg, #34d399 0%, #10b981 50%, #059669 100%);
      box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    body.dark-mode .btn-green-modern:hover {
      box-shadow: 0 12px 28px rgba(52, 211, 153, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    body.dark-mode .btn-red-modern {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 50%, #dc2626 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(248, 113, 113, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }
    
    body.dark-mode .btn-red-modern:hover {
      box-shadow: 0 12px 28px rgba(248, 113, 113, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    /* Transaction Details Box */
    .tx-details-box {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border: 2px solid #e5e7eb;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      max-height: 200px;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    body.dark-mode .tx-details-box {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
      border-color: #475569;
    }
    
    .tx-details-box .detail-row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 12px;
      align-items: flex-start;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .tx-details-box .detail-row-reason {
      align-items: flex-start;
    }
    
    body.dark-mode .tx-details-box .detail-row {
      border-bottom-color: rgba(255, 255, 255, 0.05);
    }
    
    .tx-details-box .detail-row:last-child {
      border-bottom: none;
    }
    
    .reason-list {
      color: #1f2937;
      font-weight: 500;
      word-break: break-word;
      white-space: normal;
    }
    
    body.dark-mode .reason-list {
      color: #f1f5f9;
    }
    
    .reason-list ul {
      margin: 0;
      padding-left: 20px;
      list-style-type: disc;
    }
    
    .reason-list li {
      margin: 4px 0;
      line-height: 1.5;
    }
    
    .tx-details-box strong {
      color: #4b5563;
      font-weight: 600;
      word-break: break-word;
    }
    
    body.dark-mode .tx-details-box strong {
      color: #cbd5e1;
    }
    
    .tx-details-box span {
      color: #1f2937;
      font-weight: 500;
      word-break: break-word;
      white-space: normal;
    }
    
    body.dark-mode .tx-details-box span {
      color: #f1f5f9;
    }
    
    /* System Status */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 2px solid #6ee7b7;
      border-radius: 10px;
      color: #065f46;
      font-weight: 600;
      font-size: 14px;
      margin-bottom:16px;
    }
    
    body.dark-mode .status-indicator {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
      border-color: #10b981;
      color: #6ee7b7;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Admin Logs */
    .admin-log-item {
      background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
      border: 1px solid #e5e7eb;
      border-left: 4px solid #667eea;
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 1px;
      transition: all 0.3s ease;
    }
    
    .admin-log-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    body.dark-mode .admin-log-item {
      background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
      border-color: #475569;
      border-left-color: #818cf8;
    }

    /* API Health Box Styles */
    .api-health-box {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border: 1px solid #e5e7eb;
      margin-bottom:16px;
      border-radius: 14px;
      padding: 12px;
    }
    body.dark-mode .api-health-box {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      border-color: #374151;
    }

    .api-health-title {
      font-size: 16px;
      font-weight: 600;
      color: #1b1f25;
      margin-bottom: 8px;
    }
    body.dark-mode .api-health-title {
      color: #d0d5de;
    }

    .health-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    body.dark-mode .health-item {
      border-bottom-color: #374151;
    }

    .health-item:last-child {
      border-bottom: none;
    }

    .health-item-label {
      color: #374151;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    body.dark-mode .health-item-label {
      color: #d1d5db;
    }

    .info-btn-inline {
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      font-size: 12px;
      color: white;
      padding: 3px 8px;
      border-radius: 6px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }

    .info-btn-inline::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .info-btn-inline:hover::before {
      left: 100%;
    }

    .info-btn-inline:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .info-btn-inline:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }

    body.dark-mode .info-btn-inline {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      box-shadow: 0 2px 6px rgba(79, 70, 229, 0.4);
    }

    body.dark-mode .info-btn-inline:hover {
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.5);
    }

    .health-status {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .health-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .health-text {
      font-size: 11px;
      font-weight: 600;
    }

    .health-ok .health-dot {
      background: #6ee7b7;
    }
    .health-ok .health-text {
      color: #065f46;
    }
    body.dark-mode .health-ok .health-dot {
      background: #10b981;
    }
    body.dark-mode .health-ok .health-text {
      color: #6ee7b7;
    }

    .health-error .health-dot {
      background: #fca5a5;
    }
    .health-error .health-text {
      color: #991b1b;
    }
    body.dark-mode .health-error .health-dot {
      background: #ef4444;
    }
    body.dark-mode .health-error .health-text {
      color: #fca5a5;
    }

    .health-checking .health-dot {
      background: #e5e7eb;
    }
    .health-checking .health-text {
      color: #6b7280;
    }
    body.dark-mode .health-checking .health-dot {
      background: #4b5563;
    }
    body.dark-mode .health-checking .health-text {
      color: #9ca3af;
    }

    /* System Info Styles */
    .system-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .system-info-item {
      background: #f3f4f6;
      border-radius: 10px;
      padding: 8px 10px;
    }
    body.dark-mode .system-info-item {
      background: #1f2937;
    }

    .system-info-label {
      font-size: 10px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    body.dark-mode .system-info-label {
      color: #9ca3af;
    }

    .system-info-value {
      font-size: 13px;
      color: #111827;
      font-weight: 600;
      margin-top: 2px;
    }
    body.dark-mode .system-info-value {
      color: #f9fafb;
    }
    
    /* Transaction Table */
    .tx-table-container {
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }
    
    body.dark-mode .tx-table-container {
      border-color: #334155;
    }
    
    /* Professional Transaction Table Styles */
    .professional-tx-table-wrapper {
      overflow-x: auto;
      overflow-y: hidden;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      height: 150px;
      transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .professional-tx-table-wrapper.loading-state {
      height: 150px !important;
      overflow-y: hidden !important;
    }

    .professional-tx-table-wrapper.loaded-state {
      height: auto !important;
      max-height: 600px !important;
      overflow-y: auto !important;
    }
    
    body.dark-mode .professional-tx-table-wrapper {
      border-color: #334155;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .professional-tx-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    body.dark-mode .professional-tx-table {
      background: #1e293b;
    }
    
    .tx-table-header {
      background: linear-gradient(90deg, #f9fafb 0%, #f3f4f6 100%);
      border-bottom: 2px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    body.dark-mode .tx-table-header {
      background: linear-gradient(90deg, #334155 0%, #475569 100%);
      border-bottom-color: #4b5563;
    }
    
    .tx-table-header th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 700;
      font-size: 12px;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    
    .tx-table-header th.tx-id {
      font-weight: 900;
      font-size: 14px;
      color: #1f2937;
    }
    
    .tx-table-header th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 24px;
      transition: background-color 0.2s ease;
    }
    
    .tx-table-header th.sortable:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    body.dark-mode .tx-table-header th.sortable:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .sort-indicator {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      margin-left: 6px;
      cursor: pointer;
      user-select: none;
      vertical-align: middle;
      line-height: 0.8;
      font-size: 11px;
      gap: 0px;
    }

    .sort-indicator:hover {
      opacity: 0.9;
    }

    /* Both arrows always visible */
    .sort-indicator::before {
      content: '▲';
      color: #64748b;
      display: block;
      transition: color 0.2s ease;
    }

    .sort-indicator::after {
      content: '▼';
      color: #64748b;
      display: block;
      transition: color 0.2s ease;
    }

    /* Active ascending - highlight up arrow */
    .sort-indicator.asc::before {
      color: #2563eb;
      font-weight: 900;
    }

    .sort-indicator.asc::after {
      color: #cbd5e1;
    }

    /* Active descending - highlight down arrow */
    .sort-indicator.desc::before {
      color: #cbd5e1;
    }

    .sort-indicator.desc::after {
      color: #2563eb;
      font-weight: 900;
    }

    /* Dark mode */
    body.dark-mode .sort-indicator::before,
    body.dark-mode .sort-indicator::after {
      color: #64748b;
    }

    body.dark-mode .sort-indicator.asc::before {
      color: #60a5fa;
      font-weight: 900;
    }

    body.dark-mode .sort-indicator.asc::after {
      color: #475569;
    }

    body.dark-mode .sort-indicator.desc::before {
      color: #475569;
    }

    body.dark-mode .sort-indicator.desc::after {
      color: #60a5fa;
      font-weight: 900;
    }
    
    body.dark-mode .tx-table-header th {
      color: #cbd5e1;
    }
    
    .tx-table-row {
      border-bottom: 1px solid #e5e7eb;
      background: white;
      transition: all 0.2s ease;
      height: auto;
    }
    
    .tx-table-row:hover {
      background: linear-gradient(90deg, #f9fafb 0%, #f3f4f6 100%);
    }
    
    body.dark-mode .tx-table-row {
      border-bottom-color: #334155;
      background: #1e293b;
    }
    
    body.dark-mode .tx-table-row:hover {
      background: #334155;
    }
    
    .tx-table-row:last-child {
      border-bottom: none;
    }
    
    .tx-col {
      padding: 12px;
      font-size: 14px;
      color: #1f2937;
      vertical-align: middle;
      border-right: none;
    }
    
    body.dark-mode .tx-col {
      color: #e2e8f0;
      border-right: none;
    }
    
    .tx-col:last-child {
      border-right: none;
    }
    
    .tx-id {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      font-size: 13px;
      color: #2563eb;
      min-width: 100px;
      cursor: pointer;
    }
    
    .tx-id:hover {
      color: #1d4ed8;
      opacity: 0.8;
    }
    
    body.dark-mode .tx-id {
      color: #60a5fa;
    }
    
    body.dark-mode .tx-id:hover {
      color: #93c5fd;
    }
    
    .tx-user {
      font-weight: 500;
      min-width: 90px;
    }
    
    body.dark-mode .tx-user {
      color: #e2e8f0;
    }
    
    .tx-amount {
      font-weight: 600;
      color: #047857;
      min-width: 80px;
    }
    
    body.dark-mode .tx-amount {
      color: #34d399;
    }
    
    .tx-risk {
      min-width: 70px;
    }
    
    .risk-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 56px;
      height: 28px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 12px;
      background: linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.01));
      border: 1px solid rgba(15,23,42,0.06);
    }
    
    body.dark-mode .risk-badge {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.04);
    }
    
    .tx-channel {
      min-width: 85px;
    }
    
    .channel-badge {
      display: inline-block;
      padding: 4px 8px;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    body.dark-mode .channel-badge {
      background: #312e81;
      color: #a5b4fc;
    }
    
    .tx-type {
      min-width: 75px;
      color: #6b7280;
    }
    
    body.dark-mode .tx-type {
      color: #cbd5e1;
    }
    
    body.dark-mode .tx-type span {
      color: #cbd5e1;
    }
    
    .tx-action {
      min-width: 75px;
    }
    
    .action-badge-table {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 5px 10px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 2px solid;
      background: rgba(255, 255, 255, 0.5);
    }
    
    body.dark-mode .action-badge-table {
      background: rgba(30, 41, 59, 0.8);
      color: inherit !important;
      border-width: 2px !important;
    }
    
    .tx-confidence {
      min-width: 110px;
    }
    
    .tx-time {
      min-width: 80px;
      color: #6b7280;
      font-size: 12px;
    }
    
    body.dark-mode .tx-time {
      color: #9ca3af;
    }
    
    .tx-actions {
      min-width: 230px;
      text-align: right;
      padding-right: 16px;
    }
    
    .quick-action-group {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    .tx-table-row:hover .quick-action-group {
      opacity: 1;
    }
    
    .quick-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-weight: 600;
      outline: none;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .quick-action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }
    
    .quick-action-btn:hover::before {
      left: 100%;
    }
    
    .quick-action-btn:hover {
      transform: translateY(-3px) scale(1.15);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    
    .explain-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .view-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 50%, #1d4ed8 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .allow-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    
    .delay-btn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    
    .block-btn {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    /* Old styles kept for backward compatibility - deprecated */
    .tx-row {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
    }
    
    .tx-row:hover {
      background: linear-gradient(90deg, #f9fafb 0%, #f3f4f6 100%);
      padding-left: 20px;
    }
    
    body.dark-mode .tx-row {
      background: #1e293b;
      border-bottom-color: #334155;
    }
    
    body.dark-mode .tx-row:hover {
      background: linear-gradient(90deg, #334155 0%, #475569 100%);
    }
    
    /* Action Buttons Group */
    .action-buttons {
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .tx-row:hover .action-buttons {
      opacity: 1;
    }
    
    .action-btn-sm {
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 700;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .action-btn-sm:hover {
      transform: translateY(-2px) scale(1.05);
    }
    
    /* Modals */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }
    
    .modal-content-modern {
      background: white;
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 90%;
      animation: modalSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    body.dark-mode .modal-content-modern {
      background: #1e293b;
      border: 1px solid #334155;
    }
    
    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Explainability Modal Styles */
    .explainability-modal-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      animation: modalSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    body.dark-mode .explainability-modal-container {
      background: #1e293b;
    }

    .explainability-modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      color: white;
      padding: 32px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
      flex-shrink: 0;
    }

    .explainability-modal-title {
      font-size: 28px;
      font-weight: 900;
      margin: 0;
      letter-spacing: -0.5px;
    }

    .explainability-modal-subtitle {
      font-size: 14px;
      font-weight: 500;
      opacity: 0.9;
      margin-top: 6px;
    }

    .explainability-close-btn {
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      color: white;
      line-height: 1;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      border-radius: 50%;
      opacity: 0.8;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }

    .explainability-close-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .explainability-close-btn:hover::before {
      left: 100%;
    }

    .explainability-close-btn:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .explainability-modal-content {
      padding: 32px;
      overflow-y: auto;
      flex: 1;
    }

    /* Scrollbar Styling */
    .explainability-modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .explainability-modal-content::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    body.dark-mode .explainability-modal-content::-webkit-scrollbar-track {
      background: #1e293b;
    }

    .explainability-modal-content::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
    }

    .explainability-modal-content::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }

    .explainability-tx-info {
      background: linear-gradient(135deg, #f8f9ff 0%, #f0f1ff 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }

    body.dark-mode .explainability-tx-info {
      background: linear-gradient(135deg, #1e293b 0%, #2d3e52 100%);
      border-color: rgba(102, 126, 234, 0.2);
    }

    .tx-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
    }

    .tx-info-row:not(:last-child) {
      border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }

    .tx-info-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: #667eea;
      letter-spacing: 0.5px;
    }

    .tx-info-value {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }

    body.dark-mode .tx-info-value {
      color: #f1f5f9;
    }

    .explainability-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 640px) {
      .explainability-grid {
        grid-template-columns: 1fr;
      }
    }

    .explainability-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }

    .explainability-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    body.dark-mode .explainability-card {
      background: #334155;
      border-color: #475569;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .explainability-card-header {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      color: #667eea;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
    }

    body.dark-mode .explainability-card-header {
      color: #a5b4fc;
    }

    .explainability-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .explainability-list li {
      font-size: 13px;
      line-height: 1.6;
      color: #374151;
      padding-left: 20px;
      position: relative;
    }

    .explainability-list li::before {
      content: '•';
      position: absolute;
      left: 0;
      color: #667eea;
      font-weight: bold;
      font-size: 16px;
    }

    body.dark-mode .explainability-list li {
      color: #e2e8f0;
    }

    .explainability-scores {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .explainability-scores div {
      font-size: 13px;
      line-height: 1.6;
      color: #374151;
      padding: 8px 0;
      border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }

    .explainability-scores div:last-child {
      border-bottom: none;
    }

    body.dark-mode .explainability-scores div {
      color: #e2e8f0;
      border-bottom-color: rgba(102, 126, 234, 0.2);
    }

    .explainability-scores strong {
      color: #667eea;
      font-weight: 700;
    }

    body.dark-mode .explainability-scores strong {
      color: #a5b4fc;
    }

    /* Threshold Guide Styles */
    .threshold-guide-section {
      margin-bottom: 24px;
    }

    .threshold-guide-notes {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-left: 4px solid #3b82f6;
      padding: 20px;
      border-radius: 12px;
    }

    .threshold-guide-notes .threshold-guide-title {
      color: #1e40af;
    }

    .threshold-guide-title {
      font-size: 16px;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 12px;
      margin-top: 0;
    }

    body.dark-mode .threshold-guide-title {
      color: #f1f5f9;
    }

    .threshold-guide-text {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
      margin: 0;
    }

    body.dark-mode .threshold-guide-text {
      color: #d1d5db;
    }

    .threshold-guide-items {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .threshold-guide-item {
      background: white;
      border-left: 4px solid #667eea;
      padding: 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .threshold-guide-item:hover {
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      transform: translateX(4px);
    }

    body.dark-mode .threshold-guide-item {
      background: #334155;
      border-left-color: #818cf8;
    }

    .threshold-guide-item-label {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      color: #667eea;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    body.dark-mode .threshold-guide-item-label {
      color: #a5b4fc;
    }

    .threshold-guide-item-text {
      font-size: 13px;
      line-height: 1.6;
      color: #374151;
      margin: 0;
    }

    body.dark-mode .threshold-guide-item-text {
      color: #d1d5db;
    }

    .allow-badge, .delay-badge, .block-badge {
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .allow-badge {
      background: #d1fae5;
      color: #065f46;
    }

    .delay-badge {
      background: #fef3c7;
      color: #92400e;
    }

    .block-badge {
      background: #fee2e2;
      color: #991b1b;
    }

    .threshold-guide-tips {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .tip-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: white;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .tip-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    body.dark-mode .tip-item {
      background: #334155;
      border-color: #475569;
    }

    .tip-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .tip-title {
      font-weight: 700;
      font-size: 14px;
      color: #1f2937;
      margin-bottom: 4px;
    }

    body.dark-mode .tip-title {
      color: #f1f5f9;
    }

    .tip-text {
      font-size: 13px;
      line-height: 1.5;
      color: #374151;
      margin: 0;
    }

    body.dark-mode .tip-text {
      color: #d1d5db;
    }

    .threshold-guide-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .threshold-guide-list li {
      font-size: 13px;
      line-height: 1.6;
      color: #1e40af;
      padding-left: 20px;
      position: relative;
    }

    .threshold-guide-list li::before {
      content: '✓';
      position: absolute;
      left: 0;
      color: #2563eb;
      font-weight: bold;
    }

    body.dark-mode .threshold-guide-notes {
      background: linear-gradient(135deg, #1f2a3a 0%, #243044 100%);
      border-left-color: #60a5fa;
    }

    body.dark-mode .threshold-guide-notes .threshold-guide-title {
      color: #bfdbfe;
    }

    body.dark-mode .threshold-guide-list li {
      color: #bfdbfe;
    }

    body.dark-mode .threshold-guide-list li::before {
      color: #60a5fa;
    }

    .threshold-matrix {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }

    body.dark-mode .threshold-matrix {
      background: #475569;
    }

    .matrix-row {
      display: contents;
    }

    .matrix-cell {
      background: white;
      padding: 12px;
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      color: #374151;
    }

    .matrix-cell.header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 700;
      font-size: 13px;
    }

    body.dark-mode .matrix-cell {
      background: #1e293b;
      color: #d1d5db;
    }

    @media (max-width: 640px) {
      .threshold-matrix {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .modal-title-modern {
      font-size: 24px;
      font-weight: 800;
      color: #1f2937;
      margin-bottom: 20px;
    }
    
    body.dark-mode .modal-title-modern {
      color: #f1f5f9;
    }
    
    .modal-info-box {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border-left: 4px solid #3b82f6;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
    }
    
    body.dark-mode .modal-info-box {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      border-left-color: #60a5fa;
    }
    
    /* Toast Notifications - professional card-style */
    .toast {
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      min-width: 300px;
      max-width: 480px;
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.98);
      color: #0f172a;
      border: 1px solid rgba(2,6,23,0.06);
      box-shadow: 0 6px 24px rgba(2,6,23,0.08);
      font-size: 14px;
      font-weight: 600;
      overflow: hidden;
      transform: translateX(16px);
      opacity: 0;
      transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 180ms ease;
    }

    .toast.show { transform: translateX(0); opacity: 1; }
    .toast.hide { opacity: 0; transform: translateX(8px); }

    .toast__icon { width: 44px; height: 44px; flex: 0 0 44px; display:flex; align-items:center; justify-content:center; border-radius:8px; font-size:18px }
    .toast__content { flex: 1 1 auto; min-width: 0 }
    .toast__title { font-weight:700; font-size:13px; color:#0f172a; margin-bottom:4px }
    .toast__message { font-weight:500; color:#475569; font-size:13px; line-height:1.2; word-break:break-word }
    .toast__close { margin-left:8px; background:transparent; border:0; color:#94a3b8; cursor:pointer; padding:6px; border-radius:6px }
    .toast__close:hover { background:rgba(15,23,42,0.04); color:#0f172a }
    /* Undo button: visible layout by default */
    .toast__undo { background: rgba(255,255,255,0.9); border: 1px solid rgba(15,23,42,0.06); padding:6px 10px; color:#0f172a; font-weight:700; border-radius:8px; box-shadow: 0 6px 16px rgba(2,6,23,0.06); }
    .toast__undo:hover { background: rgba(255,255,255,1); }
    body.dark-mode .toast__undo { background: rgba(255,255,255,0.04); color: #e6eef8; border: 1px solid rgba(255,255,255,0.06); box-shadow: none }
    .toast__progress { position:absolute; left:0; bottom:0; height:3px; background:linear-gradient(90deg,#60a5fa,#3b82f6); width:100%; transform-origin:left center; transform:scaleX(1); transition:transform linear }

    .toast--success .toast__icon { background:linear-gradient(135deg,#ecfdf5,#bbf7d0); color:#065f46 }
    .toast--error .toast__icon { background:linear-gradient(135deg,#fff1f2,#fecaca); color:#7f1d1d }
    .toast--info .toast__icon { background:linear-gradient(135deg,#eff6ff,#bfdbfe); color:#1e3a8a }

    body.dark-mode .toast { background: rgba(2,6,23,0.8); color:#e6eef8; border:1px solid rgba(255,255,255,0.06); box-shadow:0 8px 24px rgba(2,6,23,0.6) }
    body.dark-mode .toast__message { color:#cbd5e1 }
    body.dark-mode .toast__close { color:#cbd5e1 }
    
    /* Confidence Badges */
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 88px;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-sizing: border-box;
    }
    
    .badge-high {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .badge-medium {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #78350f;
      border: 1px solid #fbbf24;
    }
    
    .badge-low {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border: 1px solid #f87171;
    }

    /* Center confidence column cells */
    .tx-confidence { text-align: center; }
    
    /* Action Badges */
    .action-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-allow {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .badge-delay {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    
    .badge-block {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    /* Dark mode fixes */
    body.dark-mode .bg-white { background-color: #1e293b !important; color: #e5e7eb; }
    body.dark-mode .text-gray-600 { color: #cbd5e1 !important; }
    body.dark-mode .border { border-color: #334155 !important; }
    body.dark-mode a { color: #93c5fd; }
    body.dark-mode .group:hover { background-color: #334155 !important; }
    body.dark-mode .group { background-color: #1e293b !important; }
    body.dark-mode .bg-gray-50 { background-color: #334155 !important; color: #e5e7eb !important; }
    body.dark-mode .text-xs.text-gray-500 { color: #94a3b8 !important; }
    body.dark-mode input[type="text"],
    body.dark-mode input[type="email"],
    body.dark-mode input[type="password"],
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #334155 !important;
      color: #f1f5f9 !important;
      border-color: #475569 !important;
    }
    body.dark-mode input:focus,
    body.dark-mode select:focus,
    body.dark-mode textarea:focus {
      background-color: #475569 !important;
      border-color: #818cf8 !important;
    }

    body.dark-mode select:hover:not(:focus),
    body.dark-mode .input-modern:hover:not(:focus) {
      border-color: #818cf8 !important;
      box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.15) !important;
    }

    body.dark-mode h3 { color: #f1f5f9 !important; }
    body.dark-mode label { color: #e5e7eb !important; }
    body.dark-mode #confirmModal .bg-white { background-color: #1e293b !important; color: #e5e7eb; }
    body.dark-mode #confirmModal .bg-gray-50 { background-color: #334155 !important; }
    body.dark-mode #confirmModal .text-gray-600,
    body.dark-mode #confirmModal .text-gray-800 { color: #e5e7eb !important; }
    body.dark-mode #explainModal .bg-white { background-color: #1e293b !important; color: #e5e7eb !important; }
    body.dark-mode #explainModal .bg-gray-50 { background-color: #334155 !important; color: #e5e7eb !important; }
    body.dark-mode #explainModal .text-gray-800 { color: #e5e7eb !important; }
    body.dark-mode #explainModal .text-gray-600 { color: #cbd5e1 !important; }
    body.dark-mode #explainModal .text-gray-900 { color: #e5e7eb !important; }
    body.dark-mode #explainModal .text-gray-500 { color: #94a3b8 !important; }
    body.dark-mode #explainModal .text-blue-700 { color: #60a5fa !important; }
    body.dark-mode #admin_logs { background-color: transparent !important; color: #e5e7eb !important; }
    body.dark-mode #admin_logs .bg-gray-50 { background-color: #334155 !important; color: #e5e7eb !important; border-color: #475569 !important; }
    body.dark-mode #admin_logs .text-gray-500 { color: #94a3b8 !important; }
    body.dark-mode #admin_logs .text-xs { color: #cbd5e1 !important; }
    body.dark-mode #admin_logs .text-sm.font-mono { color: #cbd5e1 !important; }
    #admin_logs .bg-gray-50 { background-color: #f9fafb !important; color: #1f2937 !important; border-color: #e5e7eb !important; }
    #admin_logs .text-xs { color: #6b7280 !important; }
    #admin_logs .text-sm.font-mono { color: #1f2937 !important; }
    #admin_logs .action-badge { opacity: 1 !important; filter: none !important; mix-blend-mode: normal !important; color: #ffffff !important; }
    #admin_logs .px-2.py-0\.5.rounded.text-white { opacity: 1 !important; }
    body.dark-mode #admin_logs .action-badge { opacity: 1 !important; color: #ffffff !important; }
    body.dark-mode #admin_logs .px-2.py-0\.5.rounded.text-white { opacity: 1 !important; }
    
    /* Admin username highlighting */
    #admin_logs .admin-username {
      font-weight: 600;
      color: #2563eb;
    }
    body.dark-mode #admin_logs .admin-username {
      color: #60a5fa;
    }
    
    /* Sticky overflow message */
    .admin-log-overflow {
      position: sticky !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 10 !important;
      background: rgba(102, 126, 234, 0.95) !important;
      backdrop-filter: blur(10px) !important;
    }
    body.dark-mode .admin-log-overflow {
      background: rgba(102, 126, 234, 0.85) !important;
    }
    
    /* Hover glow buttons */
    .hover-glow-button {
      transition: all 0.3s ease;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .hover-glow-button:hover {
      transform: translateY(-2px) scale(1.05);
      filter: brightness(1.15);
    }
    .hover-glow-button.bg-blue-500:hover {
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5), 0 0 12px rgba(59, 130, 246, 0.4);
    }
    .hover-glow-button.bg-green-500:hover {
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.5), 0 0 12px rgba(34, 197, 94, 0.4);
    }
    .hover-glow-button.bg-yellow-500:hover {
      box-shadow: 0 6px 16px rgba(234, 179, 8, 0.5), 0 0 12px rgba(234, 179, 8, 0.4);
    }
    .hover-glow-button.bg-red-500:hover {
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.5), 0 0 12px rgba(239, 68, 68, 0.4);
    }
    .hover-glow-button:active {
      transform: translateY(0) scale(0.98);
    }
    body.dark-mode .hover-glow-button.bg-blue-500:hover {
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6), 0 0 16px rgba(59, 130, 246, 0.5);
    }
    body.dark-mode .hover-glow-button.bg-green-500:hover {
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.6), 0 0 16px rgba(34, 197, 94, 0.5);
    }
    body.dark-mode .hover-glow-button.bg-yellow-500:hover {
      box-shadow: 0 6px 20px rgba(234, 179, 8, 0.6), 0 0 16px rgba(234, 179, 8, 0.5);
    }
    body.dark-mode .hover-glow-button.bg-red-500:hover {
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6), 0 0 16px rgba(239, 68, 68, 0.5);
    }
    
    /* Model Accuracy Modal Dark Mode */
    body.dark-mode #modelAccuracyModal {
      background: rgba(15, 23, 42, 0.85) !important;
    }
    
    body.dark-mode #modelAccuracyModal .info-modal {
      background: #1e293b !important;
      border: 1px solid #334155;
    }

    body.dark-mode #modelAccuracyModal .info-modal-header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important;
      border-bottom-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    body.dark-mode #modelAccuracyModal .close-btn {
      background: rgba(255, 255, 255, 0.15) !important;
      color: white !important;
    }

    body.dark-mode #modelAccuracyModal .close-btn:hover {
      background: rgba(255, 255, 255, 0.25) !important;
    }

    body.dark-mode #modelAccuracyModal .info-modal-content {
      color: #cbd5e1 !important;
    }
    
    body.dark-mode #modelAccuracyModal h2,
    body.dark-mode #modelAccuracyModal h3 {
      color: #e5e7eb !important;
    }
    
    body.dark-mode #modelAccuracyModal p,
    body.dark-mode #modelAccuracyModal li,
    body.dark-mode #modelAccuracyModal span {
      color: #cbd5e1 !important;
    }
    
    body.dark-mode #modelAccuracyModal strong {
      color: #f1f5f9 !important;
    }
    
    /* Blue gradient sections */
    body.dark-mode #modelAccuracyModal .info-section[style*="linear-gradient(135deg, #f0f9ff"] {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e4d6e 100%) !important;
      border-color: #2563eb !important;
    }

    body.dark-mode #modelAccuracyModal .info-section[style*="linear-gradient(135deg, #f0f9ff"] h3 {
      color: #93c5fd !important;
    }

    body.dark-mode #modelAccuracyModal .info-section[style*="linear-gradient(135deg, #f0f9ff"] p {
      color: #bfdbfe !important;
    }

    /* Model cards */
    body.dark-mode #modelAccuracyModal div[style*="background: #fafafa"] {
      background: #334155 !important;
    }

    /* White backgrounds in ensemble section */
    body.dark-mode #modelAccuracyModal div[style*="background: white"] {
      background: #334155 !important;
      border-color: #475569 !important;
    }

    /* Weight list items */
    body.dark-mode #modelAccuracyModal li[style*="background: white"] {
      background: #334155 !important;
      border-color: #475569 !important;
    }

    /* Note paragraph in ensemble section */
    body.dark-mode #modelAccuracyModal p[style*="color: #64748b"] {
      color: #cbd5e1 !important;
      background: #334155 !important;
      border-left-color: #64748b !important;
    }

    body.dark-mode #modelAccuracyModal p[style*="color: #64748b"] strong {
      color: #e5e7eb !important;
    }

    body.dark-mode #modelAccuracyModal p[style*="color: #64748b"] em {
      color: #cbd5e1 !important;
    }
    
    /* Pro tip section */
    body.dark-mode #modelAccuracyModal .pro-tip-section {
      background: linear-gradient(135deg, #064e3b 0%, #065f46 100%) !important;
      border-left-color: #10b981 !important;
    }
    
    body.dark-mode #modelAccuracyModal .pro-tip-section strong {
      color: #6ee7b7 !important;
    }
    
    body.dark-mode #modelAccuracyModal .pro-tip-section span {
      color: #a7f3d0 !important;
    }

    /* Specific color overrides */
    body.dark-mode #modelAccuracyModal strong[style*="color: #065f46"],
    body.dark-mode #modelAccuracyModal strong[style*="color: #10b981"] {
      color: #6ee7b7 !important;
    }

    body.dark-mode #modelAccuracyModal strong[style*="color: #92400e"],
    body.dark-mode #modelAccuracyModal strong[style*="color: #f59e0b"] {
      color: #fbbf24 !important;
    }

    body.dark-mode #modelAccuracyModal strong[style*="color: #1e40af"],
    body.dark-mode #modelAccuracyModal strong[style*="color: #3b82f6"] {
      color: #93c5fd !important;
    }

    body.dark-mode #modelAccuracyModal span[style*="color: #059669"],
    body.dark-mode #modelAccuracyModal span[style*="color: #10b981"] {
      color: #6ee7b7 !important;
    }

    body.dark-mode #modelAccuracyModal span[style*="color: #d97706"],
    body.dark-mode #modelAccuracyModal span[style*="color: #f59e0b"] {
      color: #fbbf24 !important;
    }

    body.dark-mode #modelAccuracyModal span[style*="color: #2563eb"],
    body.dark-mode #modelAccuracyModal span[style*="color: #3b82f6"] {
      color: #93c5fd !important;
    }

    /* Floating Action Button Styles */
    .floating-action-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      cursor: pointer;
      font-size: 28px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      z-index: 40;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .floating-action-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
    }

    .floating-action-btn:active {
      transform: scale(0.95);
    }

    body.dark-mode .floating-action-btn {
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6);
    }

    body.dark-mode .floating-action-btn:hover {
      box-shadow: 0 12px 32px rgba(102, 126, 234, 0.8);
    }

    /* Chatbot Styles */
    .chatbot-toggle {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
      color: white;
      border: none;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .chatbot-toggle::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: chatbot-shine 3s ease-in-out infinite;
      z-index: 1;
      pointer-events: none;
    }

    @keyframes chatbot-shine {
      0% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
      }
      50% {
        transform: translateX(100%) translateY(100%) rotate(45deg);
      }
      100% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
      }
    }

    .chatbot-toggle:hover {
      transform: scale(1.12) rotate(10deg);
      box-shadow: 0 16px 40px rgba(102, 126, 234, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3), 0 0 30px rgba(102, 126, 234, 0.5);
    }

    .chatbot-toggle:active {
      transform: scale(0.95);
    }

    body.dark-mode .chatbot-toggle {
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    body.dark-mode .chatbot-toggle:hover {
      box-shadow: 0 16px 40px rgba(102, 126, 234, 0.7), inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 0 30px rgba(102, 126, 234, 0.6);
    }

    .chatbot-window {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 420px;
      max-width: calc(100vw - 48px);
      height: 600px;
      max-height: calc(100vh - 140px);
      background: white;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 1000;
      animation: slideUpFade 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid #e5e7eb;
    }

    @keyframes slideUpFade {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .chatbot-window.open {
      display: flex;
    }

    body.dark-mode .chatbot-window {
      background: #1e293b;
      border-color: #334155;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    }

    .chatbot-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 24px 24px 0 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .chatbot-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      backdrop-filter: blur(10px);
    }

    .chatbot-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: linear-gradient(135deg, #fafbfc 0%, #ffffff 100%);
    }

    body.dark-mode .chatbot-messages {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }

    .chatbot-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chatbot-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chatbot-messages::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    body.dark-mode .chatbot-messages::-webkit-scrollbar-thumb {
      background: #475569;
    }

    .chatbot-message {
      display: flex;
      max-width: 85%;
      animation: messageSlide 0.3s ease;
      margin-bottom: 8px;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chatbot-message.user {
      justify-content: flex-end;
    }

    .chatbot-message.bot {
      justify-content: flex-start;
    }

    .chatbot-message.user .chatbot-message-content {
      max-width: 95%;
    }

    .chatbot-message.bot .chatbot-message-content {
      max-width: 95%;
    }

    .chatbot-message-content {
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
      word-wrap: break-word;
      display: inline-block;
    }

    .chatbot-message.user .chatbot-message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
      font-weight: 500;
    }

    .chatbot-message.bot .chatbot-message-content {
      background: #f0f1f9;
      color: #1f2937;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    body.dark-mode .chatbot-message.bot .chatbot-message-content {
      background: #2d3e52;
      color: #e2e8f0;
      border-color: #475569;
    }

    .chatbot-input-container {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: white;
      border-top: 1px solid #e5e7eb;
      border-radius: 0 0 24px 24px;
    }

    body.dark-mode .chatbot-input-container {
      background: #1e293b;
      border-top-color: #334155;
    }

    .chatbot-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #f9fafb;
      color: #1f2937;
    }

    .chatbot-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      background: white;
    }

    body.dark-mode .chatbot-input {
      background: #0f172a;
      border-color: #475569;
      color: #f1f5f9;
    }

    .chatbot-send-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .chatbot-send-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .chatbot-send-btn:hover::before {
      left: 100%;
    }

    .chatbot-send-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .chatbot-send-btn:active {
      transform: translateY(0);
    }

    .chatbot-send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    body.dark-mode .chatbot-window {
      background: #1e293b;
    }

    body.dark-mode .chatbot-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    body.dark-mode .chatbot-messages {
      background: #334155;
    }

    body.dark-mode .chatbot-message.bot .chatbot-message-content {
      background: #475569;
      color: #e5e7eb;
    }

    body.dark-mode .chatbot-input {
      background: #475569;
      border-color: #64748b;
      color: #e5e7eb;
    }

    body.dark-mode .chatbot-input::placeholder {
      color: #94a3b8;
    }

    body.dark-mode .chatbot-input-container {
      background: #1e293b;
      border-top-color: #334155;
    }

    /* Threshold Panel Styles */
    .threshold-panel {
      background: white;
      border-radius: 24px;
      width: 100%;
      display: flex;
      flex-direction: column;
      height: 600px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
    }

    .threshold-panel-header {
      flex-shrink: 0;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }

    .threshold-panel-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .threshold-info-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .threshold-info-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .threshold-info-btn:hover::before {
      left: 100%;
    }

    .threshold-info-btn:hover {
      transform: scale(1.2) rotate(10deg);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .threshold-info-btn:active {
      transform: scale(0.95);
    }

    .threshold-panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 32px;
      color: #1f2937;
    }

    .threshold-panel-content::-webkit-scrollbar {
      width: 8px;
    }

    .threshold-panel-content::-webkit-scrollbar-track {
      background: #f3f4f6;
      border-radius: 4px;
    }

    .threshold-panel-content::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }

    .threshold-panel-content::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    body.dark-mode .threshold-panel-content::-webkit-scrollbar-track {
      background: #334155;
    }

    body.dark-mode .threshold-panel-content::-webkit-scrollbar-thumb {
      background: #64748b;
    }

    body.dark-mode .threshold-panel-content::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .threshold-panel-actions {
      flex-shrink: 0;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .threshold-section {
      margin-bottom: 32px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .threshold-section h3 {
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 16px 0;
      color: #0f172a;
    }

    .threshold-item {
      margin-bottom: 20px;
      padding: 12px;
      background: white;
      border-radius: 8px;
    }

    .threshold-item label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
      color: #374151;
    }

    .threshold-item input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #dbeafe;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .threshold-item input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .threshold-item input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .threshold-value {
      display: inline-block;
      background: #e0e7ff;
      color: #667eea;
      padding: 4px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 13px;
      min-width: 60px;
      text-align: center;
    }

    .threshold-description {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
      font-style: italic;
    }

    .threshold-panel-actions {
      display: flex;
      gap: 12px;
      padding: 24px 32px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
      justify-content: flex-end;
      border-radius: 0 0 20px 20px;
    }

    .threshold-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .threshold-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .threshold-btn:hover::before {
      left: 100%;
    }

    .threshold-btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a855f7 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }

    .threshold-btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .threshold-btn-secondary {
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      color: #667eea;
      border: 2px solid #667eea;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .threshold-btn-secondary:hover {
      background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .threshold-btn-danger {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      color: #ef4444;
      border: 2px solid #ef4444;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .threshold-btn-danger:hover {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.6);
    }

    .live-preview {
      background: #eff6ff;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #0ea5e9;
      margin-top: 16px;
      font-size: 13px;
    }

    .preview-stat {
      display: inline-block;
      margin-right: 24px;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
      font-weight: 600;
    }

    .preview-stat.allowed { color: #10b981; }
    .preview-stat.delayed { color: #f59e0b; }
    .preview-stat.blocked { color: #ef4444; }

    .threshold-header-badges {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .admin-only-badge {
      font-size: 12px;
      background: #e0e7ff;
      color: #4f46e5;
      padding: 4px 12px;
      border-radius: 6px;
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    .preset-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      border: 1px solid transparent;
    }

    .preset-status-default {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      color: #065f46;
      border-color: #6ee7b7;
    }

    .preset-status-custom {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: #1e3a8a;
      border-color: #93c5fd;
    }

    .preset-status-preset {
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      color: #5b21b6;
      border-color: #c4b5fd;
    }

    /* Preset Cards Styling */
    .preset-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .preset-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }

    .preset-card.active {
      border-color: #667eea;
      background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    }

    .preset-card.active::before {
      content: '✓';
      position: absolute;
      top: 8px;
      right: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }

    .preset-card.empty {
      border-style: dashed;
      opacity: 0.6;
    }

    .preset-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .preset-card-name {
      font-size: 14px;
      font-weight: 700;
      color: #374151;
      cursor: text;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .preset-card-name:hover {
      background: #f3f4f6;
    }

    .preset-card-name.editing {
      background: white;
      border: 1px solid #667eea;
      outline: none;
    }

    .preset-card-actions {
      display: flex;
      gap: 4px;
    }

    .preset-card-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .preset-card-btn:hover {
      background: #f3f4f6;
    }

    .preset-card-info {
      font-size: 11px;
      color: #6b7280;
      margin-top: 8px;
    }

    .preset-card-config {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 4px;
      font-family: monospace;
    }

    body.dark-mode .preset-card {
      background: #334155;
      border-color: #475569;
    }

    body.dark-mode .preset-card:hover {
      border-color: #818cf8;
    }

    body.dark-mode .preset-card.active {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
      border-color: #818cf8;
    }

    body.dark-mode .preset-card-name {
      color: #e2e8f0;
    }

    body.dark-mode .preset-card-name:hover {
      background: #475569;
    }

    body.dark-mode .preset-card-btn:hover {
      background: #475569;
    }

    body.dark-mode .admin-only-badge {
      background: rgba(99,102,241,0.15);
      color: #c7d2fe;
      border: 1px solid rgba(99,102,241,0.35);
    }

    body.dark-mode .preset-status-default {
      background: rgba(16,185,129,0.15);
      color: #a7f3d0;
      border-color: rgba(16,185,129,0.35);
    }

    body.dark-mode .preset-status-custom {
      background: rgba(59,130,246,0.15);
      color: #bfdbfe;
      border-color: rgba(59,130,246,0.35);
    }

    body.dark-mode .preset-status-preset {
      background: rgba(139,92,246,0.18);
      color: #ddd6fe;
      border-color: rgba(139,92,246,0.35);
    }

    /* Preset Section Dark Mode */
    body.dark-mode #presetsSection {
      background: #1e293b !important;
      border-bottom-color: #334155 !important;
    }

    body.dark-mode #presetsHeader h4 {
      color: #e5e7eb !important;
    }

    body.dark-mode #presetsHeader span {
      color: #64748b !important;
    }

    body.dark-mode #presetsContent span {
      color: #94a3b8 !important;
    }

    body.dark-mode #presetSlotSelect {
      background-color: #334155 !important;
      background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23cbd5e1%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e') !important;
      color: #e5e7eb !important;
      border-color: #475569 !important;
    }

    /* Animation for collapsible preset */
    @keyframes slideDown {
      from {
        opacity: 0;
        max-height: 0;
      }
      to {
        opacity: 1;
        max-height: 500px;
      }
    }

    /* Spinner animation for loading states */
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    body.dark-mode .threshold-panel {
      background: #1e293b;
      color: #e5e7eb;
      border-color: #334155;
    }

    body.dark-mode .threshold-panel-header {
      background: #1e293b;
      border-bottom-color: #334155;
    }

    body.dark-mode .threshold-section {
      background: #334155;
      border-left-color: #60a5fa;
    }

    body.dark-mode .threshold-section h3 {
      color: #f1f5f9;
    }

    body.dark-mode .threshold-item {
      background: #475569;
      color: #e5e7eb;
    }

    body.dark-mode .threshold-item label {
      color: #cbd5e1;
    }

    body.dark-mode .threshold-value {
      background: #1e3a5f;
      color: #60a5fa;
    }

    body.dark-mode .threshold-description {
      color: #94a3b8;
    }

    body.dark-mode .threshold-panel-actions {
      background: #334155;
      border-top-color: #475569;
    }

    body.dark-mode .threshold-btn-secondary {
      background: linear-gradient(135deg, #334155 0%, #425563 100%);
      color: #60a5fa;
      border-color: #60a5fa;
      box-shadow: 0 4px 15px rgba(96, 165, 250, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .threshold-btn-secondary:hover {
      background: linear-gradient(135deg, #475569 0%, #556575 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(96, 165, 250, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    body.dark-mode .threshold-btn-danger {
      background: linear-gradient(135deg, #334155 0%, #425563 100%);
      color: #f87171;
      border-color: #f87171;
      box-shadow: 0 4px 15px rgba(248, 113, 113, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .threshold-btn-danger:hover {
      background: linear-gradient(135deg, #475569 0%, #556575 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(248, 113, 113, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    body.dark-mode .live-preview {
      background: #1e3a5f;
      border-left-color: #0ea5e9;
      color: #cbd5e1;
    }

    body.dark-mode .preview-stat {
      background: #475569;
      color: #e5e7eb;
    }

    body.dark-mode .preview-stat.allowed { color: #6ee7b7; }
    body.dark-mode .preview-stat.delayed { color: #fbbf24; }
    body.dark-mode .preview-stat.blocked { color: #f87171; }

    /* Export Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    body.dark-mode .modal-content {
      background: #1e293b;
      color: #f1f5f9;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    body.dark-mode .modal-header {
      border-bottom-color: #475569;
    }

    .modal-close {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    .modal-close::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(107, 114, 128, 0.2), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .modal-close:hover::before {
      left: 100%;
    }

    .modal-close:hover {
      background: #f3f4f6;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1)
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }

    .modal-close:hover {
      background: #f3f4f6;
    }

    body.dark-mode .modal-close:hover {
      background: #334155;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }

    body.dark-mode .form-group label {
      color: #e5e7eb;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      color: #1f2937;
      font-family: 'Inter', sans-serif;
    }

    body.dark-mode .form-control {
      background: #334155;
      border-color: #475569;
      color: #f1f5f9;
    }

    .form-control:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    body.dark-mode .modal-footer {
      border-top-color: #475569;
    }

    .btn-primary, .btn-secondary {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }

    .btn-primary:hover {
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #e5e7eb;
    }

    body.dark-mode .btn-secondary {
      background: #475569;
      color: #f1f5f9;
      border-color: #64748b;
    }

    body.dark-mode .btn-secondary:hover {
      background: #64748b;
    }

    .btn-export-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #8b5cf6 100%);
      color: white;
      box-shadow: 0 6px 18px rgba(102, 126, 234, 0.35);
    }

    .btn-export-gradient:hover {
      box-shadow: 0 10px 24px rgba(124, 58, 237, 0.4);
    }

    .export-modal {
      background: white;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.2);
      max-width: 520px;
      width: 92%;
      animation: modalSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .export-modal-close {
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .export-modal-close::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .export-modal-close:hover::before {
      left: 100%;
    }

    .export-modal-close:hover {
      background: rgba(255, 255, 255, 0.35);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .export-modal-header {
      padding: 22px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .export-modal-title {
      font-size: 20px;
      font-weight: 800;
      margin: 0;
      letter-spacing: 0.2px;
    }

    .export-modal-subtitle {
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.85);
      font-weight: 500;
    }

    .export-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .export-modal-close:hover {
      background: rgba(255, 255, 255, 0.32);
      transform: scale(1.05);
    }

    .export-modal-body {
      padding: 24px;
    }

    .export-form-group {
      margin-bottom: 18px;
    }

    .export-form-group label {
      display: block;
      font-weight: 700;
      margin-bottom: 8px;
      color: #334155;
      font-size: 13px;
      letter-spacing: 0.2px;
    }

    body.dark-mode .export-form-group label {
      color: #e2e8f0;
    }

    .export-control {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 14px;
      background: white;
      color: #0f172a;
      transition: all 0.2s ease;
    }

    .export-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.18);
    }

    body.dark-mode .export-control {
      background: #1e293b;
      border-color: #334155;
      color: #f1f5f9;
    }

    body.dark-mode .export-control:focus {
      border-color: #818cf8;
      box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.25);
    }

    .select-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .select-wrapper select {
      appearance: none;
      padding-right: 42px;
    }

    .select-arrow {
      position: absolute;
      right: 14px;
      pointer-events: none;
      font-size: 12px;
      color: #64748b;
    }

    body.dark-mode .select-arrow {
      color: #cbd5e1;
    }

    .export-modal-footer {
      padding: 18px 24px 22px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      border-top: 1px solid #e2e8f0;
      background: #f8fafc;
    }

    body.dark-mode .export-modal-footer {
      background: #0f172a;
      border-top-color: #1e293b;
    }

    .export-btn-secondary {
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 600;
      border: 1px solid #d1d5db;
      background: #f8fafc;
      color: #334155;
      transition: all 0.2s ease;
    }

    .export-btn-secondary:hover {
      background: #e2e8f0;
    }

    body.dark-mode .export-btn-secondary {
      background: #1e293b;
      color: #e2e8f0;
      border-color: #334155;
    }

    body.dark-mode .export-btn-secondary:hover {
      background: #334155;
    }

    .export-btn-primary {
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 700;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 8px 18px rgba(102, 126, 234, 0.35);
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .export-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(118, 75, 162, 0.4);
    }

    .export-btn-primary.loading {
      cursor: progress;
      transform: none;
      box-shadow: 0 8px 18px rgba(102, 126, 234, 0.25);
      opacity: 0.9;
    }

    .export-btn-primary .export-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-top-color: #ffffff;
      border-radius: 9999px;
      display: none;
      animation: spin 1s linear infinite;
    }

    .export-btn-primary.loading .export-spinner {
      display: inline-block;
    }

    /* Export Audit Modal - Minimal Scoped Styles */
    #exportAuditModal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #exportAuditModal[style*="display: flex"] {
      display: flex !important;
    }

    body.dark-mode .export-modal {
      background: #1e293b;
      border-color: #334155;
    }

    body.dark-mode .export-modal-body {
      background: #1e293b;
    }
  </style>
</head>

<body class="min-h-screen p-6">
  <div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="admin-header">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="page-title">Admin Console</h1>
          <p class="page-subtitle">Fraud control & monitoring • Admin Actions • FDT2</p>
        </div>
        <div class="flex gap-3 items-center flex-wrap">
          <button id="darkModeToggleAdmin" class="btn-modern btn-primary-modern" title="Toggle Dark Mode">🌙 Dark</button>
          <a href="/dashboard" class="btn-modern btn-blue-modern">Activity Dashboard</a>
          <a href="/admin/logout" class="btn-modern btn-red-modern">Logout</a>
        </div>
      </div>
    </div>

    <!-- Top panels -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6" style="align-items: stretch;">

      <!-- Quick Action -->
      <div class="admin-card quick-action-card">
        <h3 class="text-lg font-bold">Quick Action (Manual)</h3>
        <label class="form-label-modern">Transaction ID</label>
        <input id="qa_txid" class="input-modern mb-3" placeholder="Enter TX ID" />
        <button id="qa_fetch_btn" class="btn-modern btn-blue-modern w-full mb-4">Get Details</button>
        
        <!-- Scrollable content area -->
        <div class="quick-action-content">
          <!-- Transaction Details (hidden initially) -->
          <div id="qa_details" class="hidden tx-details-box">
            <div class="detail-row"><strong>User:</strong> <span id="qa_detail_user">-</span></div>
            <div class="detail-row"><strong>Amount:</strong> <span id="qa_detail_amount">-</span></div>
            <div class="detail-row"><strong>Current Action:</strong> <span id="qa_detail_action">-</span></div>
            <div class="detail-row"><strong>Risk Score:</strong> <span id="qa_detail_risk">-</span></div>
            <div class="detail-row detail-row-reason">
              <strong>Reason:</strong>
              <div id="qa_detail_reason" class="reason-list">-</div>
            </div>
          </div>
        </div>
        
        <!-- Action section (only shown for BLOCKED transactions) -->
        <div id="qa_action_section" class="action-section hidden">
          <label class="form-label-modern">Action</label>
          <div id="qa_action_display" class="input-modern mb-4 bg-green-50 text-green-700 font-semibold border-green-200" style="display: flex; align-items: center; padding: 0 12px;">
            ALLOW (Unblock)
          </div>
          <input type="hidden" id="qa_action" value="ALLOW" />
          <button id="qa_btn" class="btn-modern btn-green-modern w-full">Unblock Transaction</button>
          <div id="qa_result" class="mt-3 text-sm text-gray-600"></div>
        </div>
        <div id="qa_no_action_msg" class="hidden mt-4 p-3 bg-gray-50 rounded text-gray-500 text-sm text-center">
          No action available. Only blocked transactions can be unblocked.
        </div>
      </div>

      <!-- System status -->
      <div class="admin-card">
        <h3 class="text-lg font-bold">System Status</h3>
        <div id="sys_status_container" style="display: flex; flex-direction: column; gap: 12px;">
          <!-- Web Connection -->
          <div id="sys_status" class="status-indicator">
            <span class="status-dot"></span>
            Live – WebSocket connected
          </div>
          
          <!-- API Health Checks -->
          <div class="api-health-box" id="api_health_box">
            <div class="api-health-title">API Endpoints Health</div>
            
            <!-- Database -->
            <div class="health-item">
              <span class="health-item-label">Database</span>
              <span id="db_health" class="health-status health-ok">
                <span class="health-dot"></span>
                <span class="health-text">Connected</span>
              </span>
            </div>
            
            <!-- Dashboard Data -->
            <div class="health-item">
              <span class="health-item-label">Dashboard Data</span>
              <span id="ep_dashboard_health" class="health-status health-checking">
                <span class="health-dot"></span>
                <span class="health-text">Checking...</span>
              </span>
            </div>
            
            <!-- Transactions -->
            <div class="health-item">
              <span class="health-item-label">Recent Transactions</span>
              <span id="ep_transactions_health" class="health-status health-checking">
                <span class="health-dot"></span>
                <span class="health-text">Checking...</span>
              </span>
            </div>
            
            <!-- Pattern Analytics -->
            <div class="health-item">
              <span class="health-item-label">Pattern Analytics</span>
              <span id="ep_patterns_health" class="health-status health-checking">
                <span class="health-dot"></span>
                <span class="health-text">Checking...</span>
              </span>
            </div>
            
            <!-- Model Accuracy -->
            <div class="health-item">
              <span class="health-item-label">
                <span>Model Accuracy</span>
                <button id="modelAccuracyInfoBtn" class="info-btn-inline" title="View Model Performance Metrics">ℹ️</button>
              </span>
              <span id="ep_models_health" class="health-status health-checking">
                <span class="health-dot"></span>
                <span class="health-text">Checking...</span>
              </span>
            </div>

            <!-- Admin Logs API -->
            <div class="health-item">
              <span class="health-item-label">Admin Logs API</span>
              <span id="ep_logs_health" class="health-status health-checking">
                <span class="health-dot"></span>
                <span class="health-text">Checking...</span>
              </span>
            </div>
          </div>

          <!-- System Information -->
          <div class="api-health-box">
            <div class="api-health-title">System Information</div>
            <div class="system-info-grid">
              <div class="system-info-item">
                <div class="system-info-label">Server Time</div>
                <div class="system-info-value" id="server_time">--:--:--</div>
              </div>
              <div class="system-info-item">
                <div class="system-info-label">Uptime</div>
                <div class="system-info-value" id="server_uptime">
                  <div style="display: inline-flex; align-items: center; gap: 6px; color: #667eea; font-size: 12px;">
                    <svg style="width: 14px; height: 14px; animation: spin 1s linear infinite;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Loading...</span>
                  </div>
                </div>
              </div>
              <div class="system-info-item">
                <div class="system-info-label">Total Logs</div>
                <div class="system-info-value" id="total_logs">0</div>
              </div>
              <div class="system-info-item">
                <div class="system-info-label">Active Session</div>
                <div class="system-info-value" id="session_status">✓ Active</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin logs -->
      <div class="admin-card">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-bold">Recent Admin Logs</h3>
          <button id="exportAuditBtn" class="btn-modern btn-export-gradient" style="padding: 8px 16px; font-size: 13px;">
            📥 Export Audit Trail
          </button>
        </div>
        <div id="admin_logs" class="text-sm overflow-y-auto overflow-x-hidden space-y-2" style="max-height: 70vh;"></div>
      </div>
    </div>

    <!-- Threshold Tuning Panel Block -->
    <div class="admin-card threshold-panel" style="margin-bottom: 24px;">
      <div class="threshold-panel-header" style="padding: 24px 32px; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
        <div class="flex justify-between items-center w-full">
          <div class="flex items-center gap-3">
            <h3 class="text-lg font-bold" style="margin: 0;">🎛️ Threshold Tuning Panel</h3>
            <button id="thresholdInfoBtn" class="threshold-info-btn" title="Threshold Tuning Help" onclick="showThresholdInfo()">ℹ️</button>
          </div>
          <div class="threshold-header-badges">
            <span id="presetStatusBadge" class="preset-status-badge preset-status-default">Default</span>
            <span class="admin-only-badge">ADMIN ONLY</span>
          </div>
        </div>
      </div>

      <!-- Presets Section - Collapsible -->
      <div id="presetsSection" style="border-bottom: 1px solid #e5e7eb; background: #f9fafb; transition: all 0.3s ease;">
        <!-- Preset Header - Always visible -->
        <div id="presetsHeader" style="padding: 16px 32px; cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center;" onclick="togglePresets()">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span id="presetsToggleIcon" style="font-size: 18px; transition: transform 0.3s ease;">▼</span>
            <h4 style="font-size: 15px; font-weight: 700; margin: 0; color: #374151;">💾 Quick Presets</h4>
          </div>
          <span style="font-size: 11px; color: #9ca3af; font-weight: 500;">Click to expand/collapse</span>
        </div>
        
        <!-- Preset Content - Collapsible -->
        <div id="presetsContent" style="padding: 0 32px 24px 32px; display: none; animation: slideDown 0.3s ease;">
          <div class="flex justify-between items-center mb-4">
            <span style="font-size: 12px; color: #6b7280;">Save current thresholds to:</span>
            <div class="flex gap-2 items-center">
              <select id="presetSlotSelect" style="padding: 6px 32px 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: white url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 24 24%27 fill=%27none%27 stroke=%27%23666%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27%3e%3cpolyline points=%276 9 12 15 18 9%27%3e%3c/polyline%3e%3c/svg%3e') no-repeat right 8px center; background-size: 16px; cursor: pointer; appearance: none; -webkit-appearance: none; -moz-appearance: none;">
                <option value="1" selected>Preset 1</option>
                <option value="2">Preset 2</option>
                <option value="3">Preset 3</option>
              </select>
              <button id="savePresetBtn" style="padding: 6px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);">
                💾 Save
              </button>
            </div>
          </div>
          <div id="presetCardsContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <!-- Preset cards will be generated here -->
          </div>
        </div>
      </div>

      <!-- Scrollable Content Area -->
      <div class="threshold-panel-content">
        <!-- Risk Score Thresholds Section -->
        <div class="threshold-section">
          <h3>🎯 Risk Score Thresholds</h3>
          <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Control decision boundaries based on ensemble fraud score (0.0 - 1.0)</p>
          
          <div class="threshold-item">
            <label>
              <span>Allow Maximum Score</span>
              <span class="threshold-value" id="allowMaxVal">0.30</span>
            </label>
            <input type="range" id="allowMaxSlider" min="0" max="0.5" step="0.01" value="0.30" style="width: 100%;">
            <div class="threshold-description">Transactions with score ≤ this value are automatically ALLOWED</div>
          </div>

          <div class="threshold-item">
            <label>
              <span>Delay Maximum Score</span>
              <span class="threshold-value" id="delayMaxVal">0.60</span>
            </label>
            <input type="range" id="delayMaxSlider" min="0.3" max="0.9" step="0.01" value="0.60" style="width: 100%;">
            <div class="threshold-description">Transactions between Allow and Delay scores are flagged for manual review</div>
          </div>

          <div class="threshold-item">
            <label>
              <span>Block Minimum Score</span>
              <span class="threshold-value" id="blockMinVal">0.60</span>
            </label>
            <input type="range" id="blockMinSlider" min="0.3" max="1.0" step="0.01" value="0.60" style="width: 100%;">
            <div class="threshold-description">Transactions with score ≥ this value are automatically BLOCKED</div>
          </div>
        </div>

        <!-- Confidence Mapping Section -->
        <div class="threshold-section">
          <h3>🔍 Confidence Mapping</h3>
          <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Define confidence levels based on model agreement</p>

          <div class="threshold-item">
            <label>
              <span>LOW Confidence Threshold</span>
              <span class="threshold-value" id="lowConfVal">0.40</span>
            </label>
            <input type="range" id="lowConfSlider" min="0" max="0.5" step="0.01" value="0.40" style="width: 100%;">
            <div class="threshold-description">Model disagreement above this gets marked as LOW confidence</div>
          </div>

          <div class="threshold-item">
            <label>
              <span>MEDIUM-HIGH Threshold</span>
              <span class="threshold-value" id="mediumConfVal">0.70</span>
            </label>
            <input type="range" id="mediumConfSlider" min="0.5" max="1.0" step="0.01" value="0.70" style="width: 100%;">
            <div class="threshold-description">Scores above this threshold are marked as HIGH confidence</div>
          </div>
        </div>

        <!-- Model Weights Section -->
        <div class="threshold-section">
          <h3>⚖️ Model Weights (Advanced)</h3>
          <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Adjust influence of each model on final ensemble score (must sum to 100%)</p>

          <div class="threshold-item">
            <label>
              <span>Random Forest Weight</span>
              <span class="threshold-value" id="rfWeightVal">35%</span>
            </label>
            <input type="range" id="rfWeightSlider" min="0" max="100" step="1" value="35" style="width: 100%;">
            <div class="threshold-description">Vote counting algorithm for pattern detection</div>
          </div>

          <div class="threshold-item">
            <label>
              <span>XGBoost Weight</span>
              <span class="threshold-value" id="xgbWeightVal">40%</span>
            </label>
            <input type="range" id="xgbWeightSlider" min="0" max="100" step="1" value="40" style="width: 100%;">
            <div class="threshold-description">Gradient boosting for high accuracy</div>
          </div>

          <div class="threshold-item">
            <label>
              <span>Isolation Forest Weight</span>
              <span class="threshold-value" id="isoWeightVal">25%</span>
            </label>
            <input type="range" id="isoWeightSlider" min="0" max="100" step="1" value="25" style="width: 100%;">
            <div class="threshold-description">Anomaly detection for outlier transactions</div>
          </div>

          <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-top: 12px; border-left: 3px solid #f59e0b; font-size: 12px; color: #b45309;">
            <strong>⚠️ Sum of weights:</strong> <span id="weightSum">100%</span> (must equal 100%)
          </div>
        </div>

        <!-- Live Preview Section -->
        <div class="live-preview">
          <strong>📈 Live Preview (Last 100 Transactions)</strong>
          <div style="margin-top: 12px;">
            <span class="preview-stat allowed">✓ Would Allow: <span id="previewAllow">-</span></span>
            <span class="preview-stat delayed">⏱️ Would Delay: <span id="previewDelay">-</span></span>
            <span class="preview-stat blocked">✕ Would Block: <span id="previewBlock">-</span></span>
          </div>
        </div>
      </div>

      <!-- Fixed Action Buttons at Bottom -->
      <div class="threshold-panel-actions" style="padding: 24px 32px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end; flex-shrink: 0;">
        <button id="resetThresholdBtn" class="threshold-btn threshold-btn-danger">🔄 Restore Defaults</button>
        <button id="applyThresholdBtn" class="threshold-btn threshold-btn-primary">✓ Apply Changes</button>
      </div>
    </div>

    <!-- Chatbot Toggle Button -->
    <button id="chatbotToggle" class="chatbot-toggle" title="Ask AI Assistant">
      💬
    </button>

    <!-- Chatbot Window -->
    <div id="chatbotWindow" class="chatbot-window">
      <div class="chatbot-header">
        <div class="flex items-center gap-2">
          <div class="chatbot-avatar">🤖</div>
          <div>
            <div class="font-semibold">SYNARA AI</div>
            <div class="text-xs opacity-75">Ask me about transactions or fraud patterns</div>
          </div>
        </div>
        <button id="chatbotClose" class="text-2xl leading-none hover:opacity-75">&times;</button>
      </div>
      
      <div id="chatbotMessages" class="chatbot-messages">
        <div class="chatbot-message bot">
          <div class="chatbot-message-content">
            Hello! I'm Synara your fraud detection assistant. Ask me about transaction patterns, risk scores, or suspicious activities.
          </div>
        </div>
      </div>
      
      <div class="chatbot-input-container">
        <input 
          type="text" 
          id="chatbotInput" 
          class="chatbot-input" 
          placeholder="Ask about transactions, patterns, risk scores..."
        />
        <button id="chatbotSend" class="chatbot-send-btn">Send</button>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
      <div class="modal-content-modern">
        <h3 class="modal-title-modern">Confirm Action</h3>
        
        <div class="modal-info-box">
          <div class="mb-2"><strong>TX ID:</strong> <span id="confirm_tx_id" class="font-mono text-blue-600">-</span></div>
          <div><strong>Action:</strong> <span id="confirm_action" class="font-bold">-</span></div>
        </div>
        
        <p class="text-sm text-gray-600 mb-6">Confirm this action. A 5-second grace window lets you undo it immediately after applying.</p>
        
        <div class="flex gap-3">
          <button id="confirm_cancel" class="flex-1 btn-modern" style="background: #9ca3af; color: white;">Cancel</button>
          <button id="confirm_submit" class="flex-1 btn-modern btn-red-modern">Confirm</button>
        </div>
      </div>
    </div>

    <!-- Explainability Modal -->
    <div id="explainModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
      <div class="explainability-modal-container">
        <div class="explainability-modal-header">
          <div>
            <h3 class="explainability-modal-title">🔍 Explainability</h3>
            <div class="explainability-modal-subtitle">Why the system decided • Suspicious patterns</div>
          </div>
          <button id="explainClose" class="explainability-close-btn">&times;</button>
        </div>

        <div class="explainability-modal-content">
          <div class="explainability-tx-info">
            <div class="tx-info-row">
              <div class="tx-info-label">TX ID</div>
              <div id="expl_tx_id" class="tx-info-value font-mono">-</div>
            </div>
            <div class="tx-info-row">
              <div class="tx-info-label">Action / Risk</div>
              <div class="tx-info-value"><span id="expl_action" class="font-semibold"></span> • <span id="expl_risk"></span></div>
            </div>
          </div>

          <div class="explainability-grid">
            <div class="explainability-card">
              <div class="explainability-card-header">Reasons</div>
              <ul id="expl_reasons" class="explainability-list"></ul>
            </div>
            <div class="explainability-card">
              <div class="explainability-card-header">Model Scores</div>
              <div id="expl_models" class="explainability-scores"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Threshold Tuning Info Modal -->
    <div id="thresholdInfoModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
      <div class="explainability-modal-container" style="max-width: 800px;">
        <div class="explainability-modal-header">
          <div>
            <h3 class="explainability-modal-title">🎛️ Threshold Tuning Guide</h3>
            <div class="explainability-modal-subtitle">Master the fraud detection thresholds • Optimize decision-making</div>
          </div>
          <button id="thresholdInfoClose" class="explainability-close-btn" onclick="closeThresholdInfo()">&times;</button>
        </div>

        <div class="explainability-modal-content">
          <div class="threshold-guide-section">
            <h4 class="threshold-guide-title">📊 What is Threshold Tuning?</h4>
            <p class="threshold-guide-text">
              Threshold tuning allows you to adjust the decision boundaries for fraud detection. These thresholds determine at which risk score level transactions are automatically allowed, delayed, or blocked.
            </p>
          </div>

          <div class="threshold-guide-section">
            <h4 class="threshold-guide-title">🎯 The Three Thresholds</h4>
            <div class="threshold-guide-items">
              <div class="threshold-guide-item">
                <div class="threshold-guide-item-label">Allow Maximum Score (0.0 - 0.5)</div>
                <p class="threshold-guide-item-text">Transactions with a risk score <strong>≤ this value</strong> are <span class="allow-badge">automatically ALLOWED</span>. Lower values = stricter (fewer false positives, but may block legitimate users).</p>
              </div>
              <div class="threshold-guide-item">
                <div class="threshold-guide-item-label">Delay Threshold (0.0 - 1.0)</div>
                <p class="threshold-guide-item-text">Transactions between Allow Max and this value are <span class="delay-badge">marked for DELAY</span>. These require manual review or additional verification.</p>
              </div>
              <div class="threshold-guide-item">
                <div class="threshold-guide-item-label">Block Minimum Score (0.5 - 1.0)</div>
                <p class="threshold-guide-item-text">Transactions with a risk score <strong>≥ this value</strong> are <span class="block-badge">automatically BLOCKED</span>. Higher values = stricter (fewer legitimate transactions blocked, but fraud may slip through).</p>
              </div>
            </div>
          </div>

          <div class="threshold-guide-section">
            <h4 class="threshold-guide-title">💡 How to Use Thresholds Effectively</h4>
            <div class="threshold-guide-tips">
              <div class="tip-item">
                <span class="tip-icon">🔍</span>
                <div>
                  <div class="tip-title">Conservative (Strict) Mode</div>
                  <p class="tip-text">Lower Allow Max (0.15-0.20) and Higher Block Min (0.75-0.90). Better fraud prevention but more customer friction.</p>
                </div>
              </div>
              <div class="tip-item">
                <span class="tip-icon">🚀</span>
                <div>
                  <div class="tip-title">Aggressive (Permissive) Mode</div>
                  <p class="tip-text">Higher Allow Max (0.40-0.50) and Lower Block Min (0.50-0.65). Better user experience but higher fraud risk.</p>
                </div>
              </div>
              <div class="tip-item">
                <span class="tip-icon">⚖️</span>
                <div>
                  <div class="tip-title">Balanced (Recommended)</div>
                  <p class="tip-text">Allow Max: 0.30, Delay: 0.60, Block Min: 0.75. Provides good balance between security and usability.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="threshold-guide-section threshold-guide-notes">
            <h4 class="threshold-guide-title" style="margin-top: 0;">⚠️ Important Notes</h4>
            <ul class="threshold-guide-list">
              <li><strong>Test First:</strong> Always test threshold changes in a non-production environment first</li>
              <li><strong>Monitor Impact:</strong> Check fraud metrics and false positive rates after changes</li>
              <li><strong>Gradual Changes:</strong> Make small adjustments (0.05 increments) and observe the impact</li>
              <li><strong>Business Hours:</strong> Implement changes during business hours when you can monitor</li>
              <li><strong>Audit Trail:</strong> All threshold changes are logged and can be audited</li>
            </ul>
          </div>

          <div class="threshold-guide-section">
            <h4 class="threshold-guide-title">💾 Quick Presets</h4>
            <p class="threshold-guide-text">Use Quick Presets to save up to three threshold configurations per admin account and switch instantly without re-tuning.</p>
            <div class="threshold-guide-items">
              <div class="threshold-guide-item">
                <div class="threshold-guide-item-label">Save a Preset</div>
                <p class="threshold-guide-item-text">Select Preset 1/2/3, then click <strong>Save</strong> to store the current thresholds.</p>
              </div>
              <div class="threshold-guide-item">
                <div class="threshold-guide-item-label">Load & Switch</div>
                <p class="threshold-guide-item-text">Click a preset card to apply it instantly. The header badge shows the active preset or <strong>Custom</strong>.</p>
              </div>
              <div class="threshold-guide-item">
                <div class="threshold-guide-item-label">Rename / Delete</div>
                <p class="threshold-guide-item-text">Double‑click a preset name to rename. Use 🗑️ to delete an unused preset.</p>
              </div>
            </div>
          </div>

          <div class="threshold-guide-section">
            <h4 class="threshold-guide-title">📈 Expected Effects of Threshold Changes</h4>
            <div class="threshold-matrix">
              <div class="matrix-row">
                <div class="matrix-cell header">Change</div>
                <div class="matrix-cell header">Fraud Detection</div>
                <div class="matrix-cell header">User Experience</div>
                <div class="matrix-cell header">Manual Review</div>
              </div>
              <div class="matrix-row">
                <div class="matrix-cell">↓ Allow Max</div>
                <div class="matrix-cell">📈 Better</div>
                <div class="matrix-cell">📉 Worse (more blocks)</div>
                <div class="matrix-cell">📈 More reviews</div>
              </div>
              <div class="matrix-row">
                <div class="matrix-cell">↑ Allow Max</div>
                <div class="matrix-cell">📉 Worse</div>
                <div class="matrix-cell">📈 Better (fewer blocks)</div>
                <div class="matrix-cell">📉 Fewer reviews</div>
              </div>
              <div class="matrix-row">
                <div class="matrix-cell">↑ Block Min</div>
                <div class="matrix-cell">📉 Worse</div>
                <div class="matrix-cell">📈 Better</div>
                <div class="matrix-cell">📉 Fewer blocks</div>
              </div>
              <div class="matrix-row">
                <div class="matrix-cell">↓ Block Min</div>
                <div class="matrix-cell">📈 Better</div>
                <div class="matrix-cell">📉 Worse</div>
                <div class="matrix-cell">📈 More blocks</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Transactions -->
    <div class="admin-card tx-card-loading" id="txAdminCard">
      <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
        <h3 class="text-lg font-bold">Transactions (Admin View)</h3>
        <div class="flex gap-3">
          <select id="timeFilter" class="input-modern" style="width: auto; min-width: 160px;">
            <option value="1h">Last 1 Hour</option>
            <option value="24h" selected>Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
          </select>
          <select id="adminFilter" class="input-modern" style="width: auto; min-width: 140px;">
            <option value="ALL">All</option>
            <option value="ALLOW">Allowed</option>
            <option value="DELAY">Delayed</option>
            <option value="BLOCK">Blocked</option>
          </select>
        </div>
      </div>
      <div class="professional-tx-table-wrapper loading-state">
        <table class="professional-tx-table" id="admin_recent"></table>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-6 right-6 z-[1001] space-y-3"></div>

  <!-- Model Accuracy Info Modal -->
  <div id="modelAccuracyModal" class="modal-overlay" style="display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(8px); z-index: 1000; align-items: center; justify-content: center;">
    <div class="info-modal" style="background: white; border-radius: 20px; max-width: 750px; width: 92%; max-height: 88vh; overflow: hidden; box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4); display: flex; flex-direction: column;">
      
      <!-- Modal Header -->
      <div class="info-modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px 32px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px 20px 0 0;">
        <div>
          <h2 style="font-size: 26px; font-weight: 800; margin: 0; color: white; letter-spacing: -0.5px;">📊 Model Performance Metrics</h2>
          <p style="font-size: 13px; color: rgba(255, 255, 255, 0.9); margin: 6px 0 0 0; font-weight: 500;">Understanding our fraud detection models</p>
        </div>
        <button id="closeModelAccuracyModal" class="close-btn" style="background: rgba(255, 255, 255, 0.2); border: none; font-size: 24px; cursor: pointer; color: white; line-height: 1; padding: 0; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: all 0.2s ease;">&times;</button>
      </div>
      
      <!-- Modal Body -->
      <div class="info-modal-content" style="color: #1f2937; line-height: 1.7; padding: 28px 32px; overflow-y: auto; flex: 1;">
        
        <div class="info-section" style="margin-bottom: 28px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 14px; border-left: 5px solid #3b82f6;">
          <h3 style="font-size: 19px; font-weight: 700; margin-bottom: 14px; color: #0c4a6e; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 24px;">🤖</span> What are Model Performance Metrics?
          </h3>
          <p style="color: #0369a1; font-size: 15px; margin: 0;">Our fraud detection system uses an ensemble of three powerful machine learning models working together. These metrics show how accurately each model identifies fraudulent transactions.</p>
        </div>

        <div class="info-section" style="margin-bottom: 28px;">
          <h3 style="font-size: 19px; font-weight: 700; margin-bottom: 16px; color: #0f172a; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
            <span style="font-size: 24px;">🧠</span> The Models
          </h3>
          <div style="display: grid; gap: 14px;">
            <div style="padding: 16px; background: #fafafa; border-radius: 10px; border-left: 4px solid #10b981;">
              <strong style="color: #065f46; font-size: 15px; display: block; margin-bottom: 6px;">🌲 Random Forest</strong>
              <p style="margin: 0; color: #475569; font-size: 14px;">Uses multiple decision trees to vote on fraud likelihood. Excellent at capturing complex patterns in transaction behavior.</p>
            </div>
            <div style="padding: 16px; background: #fafafa; border-radius: 10px; border-left: 4px solid #f59e0b;">
              <strong style="color: #92400e; font-size: 15px; display: block; margin-bottom: 6px;">⚡ XGBoost</strong>
              <p style="margin: 0; color: #475569; font-size: 14px;">Advanced gradient boosting algorithm that learns from errors. Highly accurate for structured transaction data.</p>
            </div>
            <div style="padding: 16px; background: #fafafa; border-radius: 10px; border-left: 4px solid #3b82f6;">
              <strong style="color: #1e40af; font-size: 15px; display: block; margin-bottom: 6px;">🌳 Isolation Forest</strong>
              <p style="margin: 0; color: #475569; font-size: 14px;">Specialized in anomaly detection. Identifies transactions that deviate from normal patterns.</p>
            </div>
          </div>
        </div>

        <div class="info-section" style="margin-bottom: 28px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 22px; border-radius: 14px; border: 1px solid #bae6fd;">
          <h3 style="font-size: 19px; font-weight: 700; margin-bottom: 14px; color: #0c4a6e; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 24px;">🎯</span> Ensemble Score Calculation
          </h3>
          <p style="margin-bottom: 14px; color: #0369a1; font-size: 15px;"><strong>The ensemble score is calculated using a weighted average of all three models:</strong></p>
          <div style="background: white; padding: 18px; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 14px; margin: 14px 0; color: #1e293b; border: 2px solid #cbd5e1; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);">
            <strong style="color: #3b82f6;">Ensemble Score = (w₁ × RF) + (w₂ × XGB) + (w₃ × IF)</strong>
          </div>
          <p style="margin: 14px 0 8px 0; color: #0369a1;"><strong>Default weights:</strong></p>
          <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: 8px;">
            <li style="padding: 10px 14px; background: white; border-radius: 8px; color: #475569; display: flex; justify-content: space-between; border: 1px solid #e2e8f0;">
              <span><strong style="color: #10b981;">Random Forest (w₁):</strong></span>
              <span style="font-weight: 700; color: #059669;">35%</span>
            </li>
            <li style="padding: 10px 14px; background: white; border-radius: 8px; color: #475569; display: flex; justify-content: space-between; border: 1px solid #e2e8f0;">
              <span><strong style="color: #f59e0b;">XGBoost (w₂):</strong></span>
              <span style="font-weight: 700; color: #d97706;">40%</span>
            </li>
            <li style="padding: 10px 14px; background: white; border-radius: 8px; color: #475569; display: flex; justify-content: space-between; border: 1px solid #e2e8f0;">
              <span><strong style="color: #3b82f6;">Isolation Forest (w₃):</strong></span>
              <span style="font-weight: 700; color: #2563eb;">25%</span>
            </li>
          </ul>
          <p style="margin-top: 14px; font-size: 13px; color: #64748b; padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #94a3b8;"><em><strong>Note:</strong> Weights sum to 1.0 and can be adjusted based on model performance during retraining.</em></p>
        </div>

        <div class="info-section" style="margin-bottom: 28px; padding: 20px; background: #fafafa; border-radius: 14px; border: 1px solid #e5e7eb;">
          <h3 style="font-size: 19px; font-weight: 700; margin-bottom: 14px; color: #0f172a; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 24px;">📊</span> Understanding Accuracy
          </h3>
          <p style="color: #475569; font-size: 15px; margin-bottom: 10px;"><strong style="color: #1e293b;">Accuracy Percentage:</strong> Shows what percentage of transactions the model correctly classifies as fraud or legitimate.</p>
          <div style="padding: 14px; background: white; border-radius: 10px; border-left: 4px solid #8b5cf6; margin-top: 12px;">
            <p style="margin: 0; color: #475569; font-size: 14px;"><strong style="color: #6d28d9;">Example:</strong> 97.21% accuracy means the model correctly identifies 9,721 out of 10,000 transactions.</p>
          </div>
        </div>

        <div class="info-section" style="margin-bottom: 28px; padding: 20px; background: #fafafa; border-radius: 14px; border: 1px solid #e5e7eb;">
          <h3 style="font-size: 19px; font-weight: 700; margin-bottom: 14px; color: #0f172a; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 24px;">🎯</span> Why Ensemble Matters
          </h3>
          <p style="color: #475569; font-size: 15px; margin: 0;">Using multiple models together (ensemble) reduces false positives and catches sophisticated fraud that single models might miss. Each model contributes its unique strength to the final decision.</p>
        </div>

        <div class="pro-tip-section" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding: 18px 20px; border-radius: 12px; margin-top: 24px; border-left: 5px solid #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);">
          <div style="display: flex; align-items: start; gap: 12px;">
            <span style="font-size: 28px; line-height: 1;">💡</span>
            <div>
              <strong style="color: #065f46; font-size: 16px; display: block; margin-bottom: 6px;">Pro Tip</strong>
              <span style="color: #047857; font-size: 14px; line-height: 1.6;">Model accuracy above 95% indicates excellent fraud detection capability. Regular retraining keeps models sharp and adaptive to new fraud patterns.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



<script>
let adminTxCache = [];
let adminLogCache = [];
let undoTimer = null;
let adminTableSort = { column: 'tx-time', direction: 'desc' };

/* ---------- Helpers ---------- */
function getPrevAction(tx_id) {
  const fromCache = adminTxCache.find(t => t.tx_id === tx_id);
  if (fromCache?.action) return fromCache.action;
  const detail = document.getElementById('qa_detail_action')?.textContent?.trim();
  if (detail) return detail;
  return null;
}

function updateAdminTxAction(tx_id, action, updatedTx = null) {
  const idx = adminTxCache.findIndex(t => t.tx_id === tx_id);
  if (idx >= 0) {
    const current = adminTxCache[idx] || {};
    adminTxCache[idx] = {
      ...current,
      ...(updatedTx || {}),
      action: action
    };
  }
  redrawAdminRecent();
}

function confidenceBadge(level) {
  const lvl = (level || 'HIGH').toUpperCase();
  const style = lvl === 'LOW'
    ? 'badge-low'
    : lvl === 'MEDIUM'
      ? 'badge-medium'
      : 'badge-high';
  return `<span class="confidence-badge ${style}">${lvl}</span>`;
}

/* ---------- Toast Notification System ---------- */
function escapeHtml(str){
  if (!str && str !== 0) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function getIcon(type){
  if (type === 'success') return '✅';
  if (type === 'error') return '❌';
  return 'ℹ️';
}

function showToast(type, message, title){
  const container = document.getElementById('toastContainer');
  if (!container) return;
  const toast = document.createElement('div');
  toast.setAttribute('role','status');
  toast.className = `toast toast--${type || 'info'}`;
  toast.innerHTML = `
    <div class="toast__icon" aria-hidden="true">${getIcon(type)}</div>
    <div class="toast__content">
      <div class="toast__title">${escapeHtml(title || (type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Notice'))}</div>
      <div class="toast__message">${escapeHtml(message)}</div>
    </div>
    <button class="toast__close" aria-label="Dismiss">×</button>
    <div class="toast__progress" aria-hidden="true"></div>
  `;
  container.appendChild(toast);

  const closeBtn = toast.querySelector('.toast__close');
  const progressEl = toast.querySelector('.toast__progress');

  requestAnimationFrame(()=> toast.classList.add('show'));

  const duration = 4000;
  const start = Date.now();
  let raf = null;
  function tick(){
    const elapsed = Date.now() - start;
    const pct = Math.max(0, 1 - elapsed/duration);
    if (progressEl) progressEl.style.transform = `scaleX(${pct})`;
    if (elapsed >= duration) return remove();
    raf = requestAnimationFrame(tick);
  }
  function remove(){ if (raf) cancelAnimationFrame(raf); toast.classList.remove('show'); toast.classList.add('hide'); setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 220); }
  closeBtn.addEventListener('click', e=>{ e.stopPropagation(); remove(); });
  toast.addEventListener('click', ()=> remove());
  tick();
}

function showUndoToast(tx_id, newAction, prevAction){
  const container = document.getElementById('toastContainer');
  if (!container) return;
  const toast = document.createElement('div');
  toast.setAttribute('role','status');
  toast.className = 'toast toast--info';
  toast.innerHTML = `
    <div class="toast__icon" aria-hidden="true">⏳</div>
    <div class="toast__content">
      <div class="toast__title">${escapeHtml(newAction)} applied</div>
      <div class="toast__message">${escapeHtml(tx_id.slice(0,8))} — Undo available (<span class="undo-count">5</span>s)</div>
    </div>
    <button id="undoBtn" class="toast__close toast__undo" aria-label="Undo">Undo</button>
    <div class="toast__progress" aria-hidden="true"></div>
  `;
  container.appendChild(toast);
  // animate in
  requestAnimationFrame(()=> toast.classList.add('show'));
  const countdownEl = toast.querySelector('.undo-count');
  const undoBtn = toast.querySelector('#undoBtn');
  const progressEl = toast.querySelector('.toast__progress');
  let start = Date.now(); const duration = 5000; let raf = null;
  function tick(){ const elapsed = Date.now()-start; const remain = Math.max(0, Math.ceil((duration-elapsed)/1000)); if(countdownEl) countdownEl.textContent = remain; const pct = Math.max(0,1-elapsed/duration); if(progressEl) progressEl.style.transform = `scaleX(${pct})`; if(elapsed>=duration) return remove(); raf = requestAnimationFrame(tick); }
  function remove(){ if(raf) cancelAnimationFrame(raf); try{ toast.remove(); }catch(e){} }
  undoBtn.addEventListener('click', async (e)=>{ e.stopPropagation(); try{ const res = await fetch('/admin/action',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tx_id, action: prevAction }) }); const result = await res.json(); if(!res.ok){ showToast('error', result.detail || `Failed to revert transaction ${tx_id.slice(0,8)}... to ${prevAction}`, 'Undo Failed'); } else { showToast('success', `Transaction ${tx_id.slice(0,8)}... reverted to ${prevAction}`, 'Action Undone'); addAdminLog({ tx_id, user_id: (result && result.updated && result.updated.user_id) ? result.updated.user_id : 'unknown', action: prevAction, time: new Date().toISOString() }); updateAdminTxAction(tx_id, prevAction, result.updated || null); } }catch(err){ showToast('error', err.message || 'Network error during undo operation', 'Undo Failed'); } finally { remove(); } });
  requestAnimationFrame(tick);
}

/* ---------- System Health Check ---------- */
async function checkSystemHealth() {
  try {
    const res = await fetch('/api/system-health');
    if (!res.ok) throw new Error('Health check failed');
    
    const data = await res.json();
    const components = data.components || {};
    
    // Helper function to set health status
    function setHealthStatus(elId, isHealthy) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.className = 'health-status ' + (isHealthy ? 'health-ok' : 'health-error');
      const textEl = el.querySelector('.health-text');
      if (textEl) textEl.textContent = isHealthy ? 'OK' : 'Error';
    }
    
    // Update database health
    const dbStatus = components.database?.status || 'unknown';
    const dbEl = document.getElementById('db_health');
    if (dbEl) {
      const isHealthy = dbStatus === 'healthy';
      dbEl.className = 'health-status ' + (isHealthy ? 'health-ok' : 'health-error');
      const textEl = dbEl.querySelector('.health-text');
      if (textEl) textEl.textContent = isHealthy ? 'Connected' : 'Disconnected';
    }
    
    // Update endpoint health
    const endpoints = components.endpoints || {};
    const epMappings = {
      'dashboard-data': 'ep_dashboard_health',
      'recent-transactions': 'ep_transactions_health',
      'pattern-analytics': 'ep_patterns_health',
      'model-accuracy': 'ep_models_health'
    };
    
    for (const [epName, elId] of Object.entries(epMappings)) {
      const epStatus = endpoints[epName]?.status || 'unknown';
      setHealthStatus(elId, epStatus === 'healthy');
    }

    // Check admin logs endpoint
    try {
      const logsRes = await fetch('/admin/logs?_=' + Date.now());
      setHealthStatus('ep_logs_health', logsRes.ok);
    } catch (e) {
      setHealthStatus('ep_logs_health', false);
    }

    // Update system information
    updateSystemInfo();
  } catch (e) {
    console.error('System health check error:', e);
  }
}

// Format UTC timestamp to local timezone with en-IN locale (matching web app)
// Handles timestamps from PostgreSQL TIMESTAMP type which are UTC but may lack timezone markers
function formatTimestampUTC(dateString) {
  if (!dateString || dateString === '' || dateString === 0 || dateString === '0') return '—';
  
  let normalized = String(dateString).trim();
  if (!normalized) return '—';
  
  // Check if already has explicit timezone indicator
  const hasTimezone = /[zZ]|[+-](\d{1,2}):?(\d{2})$/.test(normalized);
  
  // If no timezone info, assume UTC and append 'Z'
  if (!hasTimezone) {
    // Replace space with T if present (SQL format to ISO format)
    normalized = normalized.replace(' ', 'T');
    
    // Remove any fractional seconds beyond milliseconds (PostgreSQL microseconds)
    // e.g., "2026-02-05T16:39:30.123456" → "2026-02-05T16:39:30.123"
    normalized = normalized.replace(/(\.\d{3})\d+/, '$1');
    
    // Append Z to mark as UTC
    if (!normalized.endsWith('Z')) {
      normalized = `${normalized}Z`;
    }
  }
  
  const parsed = new Date(normalized);
  if (Number.isNaN(parsed.getTime())) {
    console.warn('[formatTimestampUTC] Failed to parse:', dateString, '→', normalized);
    return String(dateString);
  }
  
  // Convert to IST (en-IN locale) in 24-hour format
  try {
    return parsed.toLocaleTimeString('en-IN', { hour12: false });
  } catch (e) {
    console.error('[formatTimestampUTC] toLocaleTimeString failed:', e);
    return String(dateString);
  }
}

function updateSystemInfo() {
  // Update server time
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-IN', { hour12: false });
  const serverTimeEl = document.getElementById('server_time');
  if (serverTimeEl) serverTimeEl.textContent = timeStr;

  // Update total logs count
  const totalLogsEl = document.getElementById('total_logs');
  if (totalLogsEl) totalLogsEl.textContent = adminLogCache.length;

  // Calculate uptime (time since page load)
  if (!window.pageLoadTime) {
    window.pageLoadTime = Date.now();
  }
  const uptimeMs = Date.now() - window.pageLoadTime;
  const uptimeHours = Math.floor(uptimeMs / 3600000);
  const uptimeMin = Math.floor((uptimeMs % 3600000) / 60000);
  const uptimeSec = Math.floor((uptimeMs % 60000) / 1000);
  const uptimeEl = document.getElementById('server_uptime');
  if (uptimeEl) {
    if (uptimeHours > 0) {
      uptimeEl.textContent = `${uptimeHours}h ${uptimeMin}m ${uptimeSec}s`;
    } else if (uptimeMin > 0) {
      uptimeEl.textContent = `${uptimeMin}m ${uptimeSec}s`;
    } else {
      uptimeEl.textContent = `${uptimeSec}s`;
    }
  }
}

/* ---------- Setup initial page + health checks ---------- */

function updateDarkModeButtonAdmin(isDark) {
  const btn = document.getElementById('darkModeToggleAdmin');
  if (!btn) return;
  if (isDark) {
    btn.textContent = '☀️ Light';
  } else {
    btn.textContent = '🌙 Dark';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const isDark = localStorage.getItem('darkMode') === 'true';
  if (isDark) document.body.classList.add('dark-mode');
  updateDarkModeButtonAdmin(isDark);
  document.getElementById('darkModeToggleAdmin').addEventListener('click', () => {
    const nowDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', nowDark);
    updateDarkModeButtonAdmin(nowDark);
    showToast('info', nowDark ? 'Dark mode enabled - Reduced eye strain for extended admin sessions' : 'Light mode enabled - Full brightness display', 'Display Mode Changed');
  });
  
  // Setup modal buttons
  setupModalButtons();
  setupModalCloseBtn();
  
  // Setup Apply Action button
  const qaBtn = document.getElementById('qa_btn');
  if (qaBtn) {
    qaBtn.onclick = (e) => {
      e.preventDefault();
      const tx_id = document.getElementById('qa_txid').value.trim();
      const action = document.getElementById('qa_action').value;
      
      if (!tx_id) {
        document.getElementById('qa_result').textContent = 'Please enter TX ID first';
        return;
      }
      
      // Change button to loading state immediately
      qaBtn.innerHTML = `
        <div style="display: inline-flex; align-items: center; gap: 6px;">
          <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Applying action...</span>
        </div>
      `;
      qaBtn.disabled = true;
      
      showConfirmation(tx_id, action);
    };
  }
  
  // Initial health check and periodic refresh
  checkSystemHealth();
  setInterval(checkSystemHealth, 30000); // Check every 30 seconds
  
  // Update system info every second (for clock and uptime)
  setInterval(updateSystemInfo, 1000);
});

/* ---------- render transaction row ---------- */
function renderAdminTx(tx) {
  const tr = document.createElement('tr');
  tr.className = 'tx-table-row';

  const risk = Number(tx.risk_score ?? 0);
  const allowMax = typeof currentThresholds !== 'undefined'
    ? Number(currentThresholds.allowMax)
    : 0.30;
  const blockMin = typeof currentThresholds !== 'undefined'
    ? Number(currentThresholds.blockMin)
    : 0.60;
  const riskColor = risk > blockMin
    ? '#dc2626'
    : risk > allowMax
      ? '#eab308'
      : '#16a34a';
  const actionColor = tx.action === 'BLOCK' ? '#dc2626' : tx.action === 'DELAY' ? '#eab308' : '#16a34a';
  
  const timestamp = formatTimestampUTC(tx.ts || tx.created_at || tx.timestamp || 0);

  tr.innerHTML = `
    <td class="tx-col tx-time">
      <span class="text-xs text-gray-500">${timestamp}</span>
    </td>
    <td class="tx-col tx-id" onclick="fillAndScrollTx('${tx.tx_id}'); event.stopPropagation();">
      <div class="font-mono font-semibold text-blue-700">${tx.tx_id || '-'}</div>
    </td>
    <td class="tx-col tx-user">
      <span class="text-sm font-medium">${tx.user_id || '-'}</span>
    </td>
    <td class="tx-col tx-amount">
      <span class="font-semibold">₹${Number(tx.amount || 0).toFixed(2)}</span>
    </td>
    <td class="tx-col tx-risk">
      <div class="risk-badge" style="color: ${riskColor};">
        <span class="risk-value">${risk.toFixed(2)}</span>
      </div>
    </td>
    <td class="tx-col tx-channel">
      <span class="channel-badge">${tx.channel || 'N/A'}</span>
    </td>
    <td class="tx-col tx-type">
      <span class="text-sm">${tx.tx_type || 'N/A'}</span>
    </td>
    <td class="tx-col tx-action">
      <div class="action-badge-table" style="color: ${actionColor}; border-color: ${actionColor};">
        ${tx.action || 'ALLOW'}
      </div>
    </td>
    <td class="tx-col tx-confidence">
      ${confidenceBadge(tx.confidence_level)}
    </td>
    <td class="tx-col tx-actions">
      <div class="quick-action-group">
        <button onclick="showExplain('${tx.tx_id}')" class="quick-action-btn explain-btn" title="Explainability">�</button>
        <button onclick="fillAndFetchTx('${tx.tx_id}')" class="quick-action-btn view-btn" title="View Details">👁️</button>
        ${(tx.action || '').toUpperCase() === 'BLOCK' ? `<button onclick="showConfirmation('${tx.tx_id}','ALLOW')" class="quick-action-btn allow-btn" title="Unblock (Allow)">✓</button>` : ''}
      </div>
    </td>
  `;

  return tr;
}

/* ---------- Admin table sorting ---------- */
function sortAdminTable(column) {
  // Toggle direction if same column, otherwise default to desc
  if (adminTableSort.column === column) {
    adminTableSort.direction = adminTableSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    adminTableSort.column = column;
    adminTableSort.direction = 'desc';
  }

  // Sort the cache based on column and direction
  adminTxCache.sort((a, b) => {
    let aVal, bVal;

    switch (column) {
      case 'tx-time':
        aVal = new Date(a.ts || a.created_at || a.timestamp || 0).getTime();
        bVal = new Date(b.ts || b.created_at || b.timestamp || 0).getTime();
        break;
      case 'tx-user':
        aVal = (a.user_id || a.user || '').toLowerCase();
        bVal = (b.user_id || b.user || '').toLowerCase();
        break;
      case 'tx-amount':
        aVal = Number(a.amount || 0);
        bVal = Number(b.amount || 0);
        break;
      case 'tx-risk':
        aVal = Number(a.risk_score ?? a.risk ?? 0);
        bVal = Number(b.risk_score ?? b.risk ?? 0);
        break;
      case 'tx-channel':
        aVal = (a.channel || '').toLowerCase();
        bVal = (b.channel || '').toLowerCase();
        break;
      case 'tx-type':
        aVal = (a.tx_type || a.type || '').toLowerCase();
        bVal = (b.tx_type || b.type || '').toLowerCase();
        break;
      case 'tx-action':
        const actionOrder = { 'BLOCK': 1, 'DELAY': 2, 'ALLOW': 3 };
        aVal = actionOrder[(a.action || 'ALLOW').toUpperCase()] || 3;
        bVal = actionOrder[(b.action || 'ALLOW').toUpperCase()] || 3;
        break;
      case 'tx-confidence':
        const confOrder = { 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
        aVal = confOrder[(a.confidence_level || 'HIGH').toUpperCase()] || 1;
        bVal = confOrder[(b.confidence_level || 'HIGH').toUpperCase()] || 1;
        break;
      default:
        return 0;
    }

    if (aVal < bVal) return adminTableSort.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return adminTableSort.direction === 'asc' ? 1 : -1;
    return 0;
  });

  // Redraw table (sort indicators will be applied during redraw)
  redrawAdminRecent();
  
  // Show toast notification for sort
  const columnLabels = {
    'tx-time': 'Timestamp',
    'tx-id': 'Transaction ID',
    'tx-user': 'User ID',
    'tx-amount': 'Amount',
    'tx-channel': 'Channel',
    'tx-type': 'Transaction Type',
    'tx-action': 'Action',
    'tx-risk': 'Risk Score',
    'tx-confidence': 'Confidence Level'
  };
  const colLabel = columnLabels[column] || column;
  const dirLabel = adminTableSort.direction === 'asc' ? 'ascending' : 'descending';
  showToast('info', `Sorted by ${colLabel} (${dirLabel} order)`, 'Table Sorted');
}

/* ---------- load recent ---------- */
async function fetchRecent() {
  showAdminLoading();
  const timeRange = document.getElementById('timeFilter')?.value || '24h';
  const res = await fetch(`/recent-transactions?limit=2000&time_range=${timeRange}`);
  const j = await res.json();
  adminTxCache = Array.isArray(j.transactions) ? j.transactions : [];
  redrawAdminRecent();
}

function redrawAdminRecent() {
  const el = document.getElementById('admin_recent');
  const wrapper = el?.closest('.professional-tx-table-wrapper');
  const filter = document.getElementById('adminFilter')?.value || 'ALL';

  el.innerHTML = '';

  // Add table headers
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.className = 'tx-table-header';
  
  const headers = [
    { col: 'tx-time', label: 'Time', sortable: true },
    { col: 'tx-id', label: 'TX ID', sortable: false },
    { col: 'tx-user', label: 'User', sortable: true },
    { col: 'tx-amount', label: 'Amount', sortable: true },
    { col: 'tx-risk', label: 'Risk', sortable: true },
    { col: 'tx-channel', label: 'Channel', sortable: true },
    { col: 'tx-type', label: 'Type', sortable: true },
    { col: 'tx-action', label: 'Action', sortable: true },
    { col: 'tx-confidence', label: 'Confidence', sortable: true },
    { col: 'tx-actions', label: 'Actions', sortable: false }
  ];
  
  headers.forEach(header => {
    const th = document.createElement('th');
    th.className = `tx-col ${header.col}`;
    
    if (header.sortable) {
      th.classList.add('sortable');
      
      const span = document.createElement('span');
      span.className = 'sort-indicator';
      span.dataset.column = header.col;
      
      // Apply current sort state
      if (adminTableSort.column === header.col) {
        span.classList.add(adminTableSort.direction);
      }
      
      span.onclick = (e) => {
        e.stopPropagation();
        sortAdminTable(header.col);
      };
      
      th.textContent = header.label + ' ';
      th.appendChild(span);
    } else {
      th.textContent = header.label;
    }
    
    headerRow.appendChild(th);
  });
  
  thead.appendChild(headerRow);
  el.appendChild(thead);

  const filteredTxs = adminTxCache.filter(tx => filter === 'ALL' || tx.action === filter);
  
  if (filteredTxs.length === 0) {
    // Show message if no transactions (either empty cache or filtered out)
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="10" style="padding: 40px; text-align: center; color: #9ca3af;">No transactions found</td>';
    el.appendChild(tr);
    return;
  }
  
  // PERFORMANCE: Use document fragment and limit to 100 rows
  const fragment = document.createDocumentFragment();
  const maxRows = 100;
  const rowsToRender = filteredTxs.slice(0, maxRows);
  
  rowsToRender.forEach(tx => fragment.appendChild(renderAdminTx(tx)));
  
  // Show message if more rows exist
  if (filteredTxs.length > maxRows) {
    console.log(`TX Table overflow: ${filteredTxs.length} > ${maxRows}`);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="10" style="padding: 20px; text-align: center; color: #ffffff; font-weight: 600; background: rgba(102, 126, 234, 0.95); border-radius: 8px; position: sticky; bottom: 0; left: 0; right: 0; z-index: 10;">Showing ${maxRows} of ${filteredTxs.length} transactions. Use filters to narrow results.</td>`;
    fragment.appendChild(tr);
  }
  
  el.appendChild(fragment);
  
  // Apply loaded state for smooth expansion
  const txCard = document.getElementById('txAdminCard');
  if (wrapper) {
    wrapper.classList.remove('loading-state');
    wrapper.classList.add('loaded-state');
  }
  if (txCard) {
    txCard.classList.remove('tx-card-loading');
    txCard.classList.add('tx-card-loaded');
  }
}

function showAdminLoading() {
  const el = document.getElementById('admin_recent');
  const wrapper = el?.closest('.professional-tx-table-wrapper');
  const txCard = document.getElementById('txAdminCard');
  if (wrapper) {
    wrapper.classList.remove('loaded-state');
    wrapper.classList.add('loading-state');
  }
  if (txCard) {
    txCard.classList.remove('tx-card-loaded');
    txCard.classList.add('tx-card-loading');
  }
  el.innerHTML = `
    <tr class="tx-table-row" style="height: 150px;">
      <td colspan="10" style="text-align: center; padding: 40px 20px;">
        <div style="display: inline-flex; align-items: center; gap: 8px; color: #667eea;">
          <svg style="width: 20px; height: 20px; animation: spin 1s linear infinite;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span style="font-size: 14px; font-weight: 600;">Loading transactions...</span>
        </div>
      </td>
    </tr>
  `;
}

/* ---------- explainability modal ---------- */
function hideExplain() {
  document.getElementById('explainModal')?.classList.add('hidden');
}

function showExplain(tx_id) {
  const modal = document.getElementById('explainModal');
  if (!modal) return;

  const tx = adminTxCache.find(t => t.tx_id === tx_id);
  if (!tx) {
    showToast('error', `Cannot display details - Transaction ${tx_id.substring(0, 8)}... not found`, 'Transaction Not Found');
    return;
  }

  console.log('showExplain - Full transaction data:', tx);
  console.log('showExplain - Explainability field:', tx.explainability);

  showToast('info', `Displaying fraud detection analysis for transaction ${tx_id.substring(0, 12)}...`, 'Explainability Details');

  // Try multiple ways to get explainability data
  let expl = {};
  if (tx.explainability) {
    // If it's a string (JSON), parse it
    if (typeof tx.explainability === 'string') {
      try {
        expl = JSON.parse(tx.explainability);
      } catch (e) {
        console.error('Failed to parse explainability JSON:', e);
        expl = {};
      }
    } else {
      expl = tx.explainability;
    }
  }
  
  const reasonsRaw = expl.reasons || tx.reasons || tx.fraud_reasons || [];
  const modelScores = expl.model_scores || tx.model_scores || {};
  
  console.log('Extracted reasons:', reasonsRaw);
  console.log('Extracted model scores:', modelScores);

  document.getElementById('expl_tx_id').textContent = tx.tx_id || '-';

  const actionEl = document.getElementById('expl_action');
  const action = tx.action || 'N/A';
  actionEl.textContent = action;
  actionEl.className = 'font-semibold ' + (
    action === 'BLOCK' ? 'text-red-600' :
    action === 'DELAY' ? 'text-yellow-600' : 'text-green-600'
  );

  document.getElementById('expl_risk').textContent = `Risk ${Number(tx.risk_score ?? 0).toFixed(2)}`;

  const reasonsEl = document.getElementById('expl_reasons');
  reasonsEl.innerHTML = '';
  const reasonItems = Array.isArray(reasonsRaw) ? reasonsRaw : [];
  if (reasonItems.length === 0) {
    const li = document.createElement('li');
    li.className = 'text-gray-500 italic';
    li.textContent = 'No explainability data available. This may be an older transaction or the explainability column is not yet created.';
    reasonsEl.appendChild(li);
  } else {
    reasonItems.forEach(r => {
      const text = typeof r === 'string' ? r : (r.reason || JSON.stringify(r));
      const li = document.createElement('li');
      li.textContent = text;
      reasonsEl.appendChild(li);
    });
  }

  const modelsEl = document.getElementById('expl_models');
  modelsEl.innerHTML = '';
  // Filter out meta fields and enforce display order
  const filtered = { ...(modelScores || {}) };
  ['confidence','model_disagreement','confidence_level','disagreement','final_risk_score'].forEach(k => { if (k in filtered) delete filtered[k]; });
  const order = ['iforest','random_forest','xgboost','ensemble'];
  const orderedEntries = [];
  order.forEach(k => { if (k in filtered) orderedEntries.push([k, filtered[k]]); });
  // Append any other scores not in the order
  Object.entries(filtered).forEach(([k,v]) => { if (!order.includes(k)) orderedEntries.push([k,v]); });

  if (orderedEntries.length === 0) {
    const div = document.createElement('div');
    div.className = 'text-gray-500 italic';
    div.textContent = 'No model scores available. Run the migration to add the explainability column.';
    modelsEl.appendChild(div);
  } else {
    orderedEntries.forEach(([k, v]) => {
      const div = document.createElement('div');
      div.innerHTML = `<span class="font-semibold text-gray-900">${k.replace('_',' ')}:</span> <span class="font-semibold text-gray-800">${Number(v ?? 0).toFixed(3)}</span>`;
      div.className = 'mb-1';
      modelsEl.appendChild(div);
    });
  }

  modal.classList.remove('hidden');
}

/* ---------- threshold tuning info modal ---------- */
function showThresholdInfo() {
  const modal = document.getElementById('thresholdInfoModal');
  if (modal) {
    modal.classList.remove('hidden');
    showToast('info', 'Learn how to optimize risk thresholds, confidence levels, and model weights', 'Threshold Tuning Guide');
  }
}

function closeThresholdInfo() {
  const modal = document.getElementById('thresholdInfoModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}


/* ---------- quick action ---------- */
async function quickAction(tx_id, action) {
  const res = await fetch('/admin/action', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ tx_id, action })
  });
  
  const result = await res.json();

  const logs = document.getElementById('admin_logs');
  const log = document.createElement('div');
  log.className = 'admin-log-item';

  const badgeClass = action === 'BLOCK' ? 'badge-block' : (action === 'DELAY' ? 'badge-delay' : 'badge-allow');
  log.innerHTML = `
    <div class="flex justify-between items-center">
      <div class="text-xs font-mono font-semibold">${tx_id}</div>
      <div class="flex items-center gap-2">
        <span class="text-[10px] text-gray-500">${formatTimestampUTC(new Date().toISOString())}</span>
        <span class="action-badge ${badgeClass}">${action}</span>
      </div>
    </div>
  `;

  logs.prepend(log);
  return result;
}

/* ---------- clear details when TX ID input changes ---------- */
document.getElementById('qa_txid').addEventListener('input', () => {
  document.getElementById('qa_details').classList.add('hidden');
  document.getElementById('qa_btn').disabled = true;
  document.getElementById('qa_result').textContent = '';
});

/* ---------- fetch transaction details ---------- */
document.getElementById('qa_fetch_btn').onclick = async () => {
  const btn = document.getElementById('qa_fetch_btn');
  const tx_id = document.getElementById('qa_txid').value.trim();
  
  if (!tx_id) {
    document.getElementById('qa_result').textContent = 'Please enter TX ID';
    return;
  }

  // Show loading state
  const originalText = btn.textContent;
  btn.innerHTML = `
    <div style="display: inline-flex; align-items: center; gap: 6px;">
      <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>Getting details...</span>
    </div>
  `;
  btn.disabled = true;

  try {
    const res = await fetch(`/recent-transactions?limit=1000`);
    const j = await res.json();
    const tx = (j.transactions || []).find(t => t.tx_id === tx_id);

    if (!tx) {
      showToast('error', `Transaction ${tx_id.substring(0, 8)}... not found in recent transactions`, 'Not Found');
      document.getElementById('qa_result').textContent = 'Transaction not found';
      return;
    }

    // Display transaction details
    document.getElementById('qa_detail_user').textContent = tx.user_id || 'N/A';
    document.getElementById('qa_detail_amount').textContent = `₹${Number(tx.amount || 0).toFixed(2)}`;
    document.getElementById('qa_detail_action').textContent = tx.action || 'PENDING';
    document.getElementById('qa_detail_risk').textContent = Number(tx.risk_score || 0).toFixed(2);
    
    // Show/hide action section based on transaction status
    const actionSection = document.getElementById('qa_action_section');
    const noActionMsg = document.getElementById('qa_no_action_msg');
    const currentAction = (tx.action || '').toUpperCase();
    
    if (currentAction === 'BLOCK') {
      actionSection.classList.remove('hidden');
      noActionMsg.classList.add('hidden');
      document.getElementById('qa_btn').disabled = false;
    } else {
      actionSection.classList.add('hidden');
      noActionMsg.classList.remove('hidden');
    }
    
    // Show explainability reasons if present
    const reasonEl = document.getElementById('qa_detail_reason');
    const reasons = tx.explainability?.reasons;
    
    if (Array.isArray(reasons) && reasons.length) {
      // Format as bullet list
      reasonEl.innerHTML = '<ul>' + reasons.map(r => `<li>${r}</li>`).join('') + '</ul>';
    } else {
      let reason = 'N/A';
      if (tx.block_reason) {
        // Parse block_reason for semicolons or other delimiters
        const reasonParts = tx.block_reason.split(/;|\n/).map(r => r.trim()).filter(r => r);
        if (reasonParts.length > 1) {
          reasonEl.innerHTML = '<ul>' + reasonParts.map(r => `<li>${r}</li>`).join('') + '</ul>';
        } else {
          reasonEl.textContent = tx.block_reason;
        }
      } else if (tx.action === 'BLOCK') {
        reasonEl.textContent = `High risk score (${Number(tx.risk_score || 0).toFixed(2)})`;
      } else if (tx.action === 'DELAY') {
        reasonEl.textContent = 'Verification pending';
      } else if (tx.action === 'ALLOW') {
        reasonEl.textContent = 'Cleared';
      } else {
        reasonEl.textContent = reason;
      }
    }
    
    document.getElementById('qa_details').classList.remove('hidden');
    document.getElementById('qa_btn').disabled = false;
    document.getElementById('qa_result').textContent = 'Details loaded. Choose action below.';
  } catch (e) {
    document.getElementById('qa_result').textContent = 'Error: ' + e.message;
  } finally {
    // Restore button state
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
};

/* ---------- fill TX ID from transaction row (no auto-fetch) ---------- */
function fillTxIdOnly(tx_id) {
  const input = document.getElementById('qa_txid');
  input.value = tx_id;
  // Clear details panel
  document.getElementById('qa_details').classList.add('hidden');
  document.getElementById('qa_btn').disabled = true;
  document.getElementById('qa_result').textContent = '';
}

/* ---------- fill TX ID and scroll to Quick Action (TX ID click only) ---------- */
function fillAndScrollTx(tx_id) {
  // Fill TX ID only
  fillTxIdOnly(tx_id);
  // Scroll to Quick Action block
  const quickActionCard = document.querySelector('.quick-action-card');
  if (quickActionCard) {
    quickActionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  showToast('info', `Transaction ${tx_id.substring(0, 12)}... loaded into Quick Action panel`, 'Transaction Selected');
}

/* ---------- fill TX ID and fetch details (View button) ---------- */
function fillAndFetchTx(tx_id) {
  // Fill TX ID
  fillTxIdOnly(tx_id);
  // Scroll to Quick Action block
  const quickActionCard = document.querySelector('.quick-action-card');
  if (quickActionCard) {
    quickActionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  showToast('info', `Fetching detailed information for transaction ${tx_id.substring(0, 12)}...`, 'Loading Details');
  // Auto-fetch details after a short delay to allow scroll
  setTimeout(() => {
    document.getElementById('qa_fetch_btn').click();
  }, 300);
}


/* ---------- confirmation modal logic ---------- */
let pendingAction = null;

function showConfirmation(tx_id, action) {
  console.log('showConfirmation called:', tx_id, action);
  
  // Security: Only ALLOW action is permitted (unblocking blocked transactions)
  if (action.toUpperCase() !== 'ALLOW') {
    showToast('error', 'Admin can only unblock (ALLOW) transactions. Other actions are not permitted for security reasons.', 'Action Not Allowed');
    return;
  }
  
  // Check if transaction is currently blocked
  const tx = adminTxCache.find(t => t.tx_id === tx_id);
  if (tx) {
    const currentAction = (tx.action || '').toUpperCase();
    if (currentAction !== 'BLOCK') {
      showToast('warning', `Transaction ${tx_id.substring(0, 12)}... is not blocked (current status: ${currentAction}). Only blocked transactions can be unblocked.`, 'Cannot Unblock');
      return;
    }
    if (currentAction === 'ALLOW') {
      showToast('info', `Transaction ${tx_id.substring(0, 12)}... is already allowed.`, 'Already Allowed');
      return;
    }
  }
  
  pendingAction = { tx_id, action };
  document.getElementById('confirm_tx_id').textContent = tx_id;
  document.getElementById('confirm_action').textContent = 'UNBLOCK (ALLOW)';
  
  // Color code - always green for ALLOW
  const actionEl = document.getElementById('confirm_action');
  actionEl.className = 'font-bold text-green-600';
  
  document.getElementById('confirmModal').classList.remove('hidden');
}

function hideConfirmation() {
  document.getElementById('confirmModal').classList.add('hidden');
  pendingAction = null;
  
  // Restore Apply Action button state
  const applyBtn = document.getElementById('qa_btn');
  if (applyBtn) {
    applyBtn.textContent = 'Apply Action';
    applyBtn.disabled = false;
  }
}

// Setup modal buttons in DOMContentLoaded
function setupModalButtons() {
  const cancelBtn = document.getElementById('confirm_cancel');
  const submitBtn = document.getElementById('confirm_submit');
  const explainClose = document.getElementById('explainClose');
  const explainModal = document.getElementById('explainModal');
  
  if (cancelBtn) {
    cancelBtn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      hideConfirmation();
    };
  }
  
  if (submitBtn) {
    submitBtn.onclick = async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (!pendingAction) {
        alert('No action pending');
        return;
      }
      
      const tx_id = pendingAction.tx_id;
      const action = pendingAction.action;
      const prevAction = getPrevAction(tx_id) || 'ALLOW';
      
      // Show loading state on modal button
      const originalText = submitBtn.textContent;
      submitBtn.innerHTML = `
        <div style="display: inline-flex; align-items: center; gap: 6px;">
          <svg style="width: 16px; height: 16px; animation: spin 1s linear infinite;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Applying action...</span>
        </div>
      `;
      submitBtn.disabled = true;
      
      // Apply Action button is already in loading state, no need to change it again
      
      hideConfirmation();
      
      try {
        console.log('Submitting action:', tx_id, action);
        
        const response = await fetch('/admin/action', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ tx_id, action })
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          showToast('error', result.detail || `Could not apply ${action} action to transaction ${tx_id.substring(0, 8)}...`, 'Action Failed');
          document.getElementById('qa_result').textContent = 'Error: ' + result.detail;
          return;
        }
        
        console.log('Action result:', result);
        // Show success toast (undo removed for security - once unblocked, stays unblocked)
        const actionVerb = action === 'ALLOW' ? 'Unblocked' : action;
        showToast('success', `Transaction ${tx_id.substring(0, 8)}... has been ${actionVerb.toLowerCase()} successfully`, `${actionVerb}`);
        document.getElementById('qa_result').textContent = '✓ Transaction unblocked successfully!';
        
        // Add to admin logs
        addAdminLog({
          tx_id: tx_id,
          user_id: result.updated?.user_id || 'unknown',
          action: action,
          time: new Date().toISOString()
        });
        
        // Clear form after successful action
        document.getElementById('qa_txid').value = '';
        document.getElementById('qa_details').classList.add('hidden');
        document.getElementById('qa_action_section').classList.add('hidden');
        
      } catch (e) {
        console.error('Error:', e);
        document.getElementById('qa_result').textContent = 'Error: ' + e.message;
      } finally {
        // Restore modal button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Restore Apply Action button state
        const applyBtn = document.getElementById('qa_btn');
        if (applyBtn) {
          applyBtn.innerHTML = 'Apply Action';
          applyBtn.disabled = false;
        }
      }
    };
  }

  if (explainClose) {
    explainClose.onclick = (e) => {
      e.preventDefault();
      hideExplain();
    };
  }

  if (explainModal) {
    explainModal.onclick = (e) => {
      if (e.target.id === 'explainModal') hideExplain();
    };
  }

  // Threshold Info Modal listeners
  const thresholdInfoModal = document.getElementById('thresholdInfoModal');
  const thresholdInfoClose = document.getElementById('thresholdInfoClose');
  
  if (thresholdInfoClose) {
    thresholdInfoClose.onclick = (e) => {
      e.preventDefault();
      closeThresholdInfo();
    };
  }

  if (thresholdInfoModal) {
    thresholdInfoModal.onclick = (e) => {
      if (e.target.id === 'thresholdInfoModal') closeThresholdInfo();
    };
  }
}

/* ---------- setup modal close button ---------- */
function setupModalCloseBtn() {
  const modal = document.getElementById('confirmModal');
  if (modal) {
    modal.onclick = (e) => {
      if (e.target.id === 'confirmModal') {
        hideConfirmation();
      }
    };
  }
}

/* ---------- websocket live updates ---------- */
let wsUpdateTimeout = null;
let hasPendingUpdate = false;

function debouncedRedraw() {
  if (wsUpdateTimeout) {
    hasPendingUpdate = true;
    return;
  }
  
  redrawAdminRecent();
  
  wsUpdateTimeout = setTimeout(() => {
    wsUpdateTimeout = null;
    if (hasPendingUpdate) {
      hasPendingUpdate = false;
      debouncedRedraw();
    }
  }, 500); // Redraw at most every 500ms
}

function setupWS() {
  const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss':'ws'}://${location.host}/ws`);

  ws.onmessage = ev => {
    const msg = JSON.parse(ev.data);
    if (!msg.data) return;

    if (msg.type === 'tx_inserted') {
      adminTxCache.unshift(msg.data);
      adminTxCache = adminTxCache.slice(0, 100); // Keep more in cache but only show 100
      debouncedRedraw();
    }

    if (msg.type === 'tx_updated') {
      const idx = adminTxCache.findIndex(t => t.tx_id === msg.data.tx_id);
      if (idx !== -1) {
        adminTxCache[idx] = msg.data;
        debouncedRedraw();
      }
    }
  };

  ws.onclose = () => setTimeout(setupWS, 2000);
}

/* ---------- Admin Logs Persistence (localStorage) ---------- */
const ADMIN_LOGS_KEY = 'fdt_admin_logs';
const MAX_STORED_LOGS = 100;

function saveAdminLogToStorage(log) {
  try {
    let logs = JSON.parse(localStorage.getItem(ADMIN_LOGS_KEY) || '[]');
    logs.unshift({ ...log, timestamp: Date.now() });
    logs = logs.slice(0, MAX_STORED_LOGS);
    localStorage.setItem(ADMIN_LOGS_KEY, JSON.stringify(logs));
  } catch (e) {
    console.error('Failed to save admin log to storage:', e);
  }
}

function loadAdminLogsFromStorage() {
  try {
    const logs = JSON.parse(localStorage.getItem(ADMIN_LOGS_KEY) || '[]');
    const el = document.getElementById('admin_logs');
    if (!el) return;
    
    el.innerHTML = '';
    logs.forEach(log => {
      const div = document.createElement('div');
      div.className = 'admin-log-item';
      
      const badgeClass = log.action === 'BLOCK' ? 'badge-block' : (log.action === 'DELAY' ? 'badge-delay' : 'badge-allow');
      div.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <div class="font-mono text-sm font-semibold">${log.tx_id}</div>
            <div class="text-xs text-gray-500 mt-1">
              User: <span class="font-semibold">${log.user_id || 'unknown'}</span>
              • ${formatTimestampUTC(log.time)}
            </div>
          </div>
          <span class="action-badge ${badgeClass}">${log.action}</span>
        </div>
      `;
      
      el.appendChild(div);
    });
    
    // Show overflow message if there are more logs
    if (logs.length > maxLogs) {
      const overflowDiv = document.createElement('div');
      overflowDiv.className = 'admin-log-overflow';
      overflowDiv.style.cssText = 'padding: 16px; text-align: center; color: #667eea; font-weight: 600; background: rgba(102, 126, 234, 0.1); border-radius: 8px; margin-top: 8px;';
      overflowDiv.textContent = `Showing ${maxLogs} of ${logs.length} total admin logs`;
      el.appendChild(overflowDiv);
    }
  } catch (e) {
    console.error('Failed to load admin logs from storage:', e);
  }
}

async function loadAdminLogsFromServer() {
  try {
    const res = await fetch(`/admin/logs?_=${Date.now()}`);
    if (!res.ok) throw new Error('Failed to fetch admin logs');
    
    const data = await res.json();
    const logs = data.logs || [];
    
    // Store ALL logs in cache
    adminLogCache = logs;
    console.log(`Loaded ${logs.length} admin logs into cache`);
    
    const el = document.getElementById('admin_logs');
    if (!el) return;
    
    el.innerHTML = '';
    
    // Display only the most recent 100 logs
    const maxLogs = 100;
    const logsToDisplay = logs.slice(0, maxLogs);
    
    logsToDisplay.forEach(log => {
      const ts = log.created_at || log.time || log.timestamp || log.createdAt || log.time_created;
      // Parse timestamp with UTC timezone handling
      let tsText = '—';
      if (ts) {
        try {
          // If timestamp doesn't have timezone info, add Z to treat as UTC
          let isoString = ts;
          if (typeof ts === 'string') {
            // Check if timezone info exists (Z, +, or - after time)
            if (!ts.includes('Z') && !ts.includes('+') && !ts.includes('-', 19)) {
              isoString = ts + 'Z';
            }
          }
          const date = new Date(isoString);
          if (!isNaN(date)) {
            tsText = formatTimestampUTC(isoString);
          }
        } catch (e) {
          tsText = '—';
        }
      }
      
      const div = document.createElement('div');
      div.className = 'admin-log-item';
      
      const badgeClass = log.action === 'BLOCK' ? 'badge-block' : (log.action === 'DELAY' ? 'badge-delay' : 'badge-allow');
      div.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <div class="font-mono text-sm font-semibold">${log.tx_id}</div>
            <div class="text-xs text-gray-500 mt-1">
              User: <span class="font-semibold">${log.user_id || 'unknown'}</span>
              • Admin: <span class="admin-username">${log.admin_username || 'system'}</span>
              • ${tsText}
            </div>
          </div>
          <span class="action-badge ${badgeClass}">${log.action}</span>
        </div>
      `;
      
      el.appendChild(div);
    });
    
    // Show overflow message if there are more logs
    if (logs.length > maxLogs) {
      console.log(`Showing overflow message: ${logs.length} > ${maxLogs}`);
      const overflowDiv = document.createElement('div');
      overflowDiv.className = 'admin-log-overflow';
      overflowDiv.style.cssText = 'padding: 16px; text-align: center; color: #ffffff; font-weight: 600; background: rgba(102, 126, 234, 0.95); border-radius: 8px; margin-top: 8px; position: sticky; bottom: 0; left: 0; right: 0; z-index: 10; backdrop-filter: blur(10px);';
      overflowDiv.textContent = `Showing ${maxLogs} of ${logs.length} total admin logs`;
      el.appendChild(overflowDiv);
    } else {
      console.log(`No overflow: ${logs.length} <= ${maxLogs}`);
    }
    
    // Update system info to reflect log count
    updateSystemInfo();
  } catch (e) {
    console.error('Failed to load admin logs from server:', e);
    // Fallback to localStorage if server fetch fails
    loadAdminLogsFromStorage();
  }
}
function addAdminLog(log) {
    // The backend's /admin/action endpoint already saved the log
    // Just refresh the logs list to display the new entry
    loadAdminLogsFromServer();
  }


fetchRecent();
setupWS();

// Load admin logs from server on page load (cross-device persistence)
loadAdminLogsFromServer();

// Welcome toast on page load
setTimeout(() => {
  showToast('success', 'Admin console loaded - Real-time transaction monitoring and management active', 'Welcome Back');
}, 500);

// Refresh admin logs every 30 seconds to catch updates from other admins
setInterval(loadAdminLogsFromServer, 30000);

// Chatbot setup
let chatHistory = [];

function addChatMessage(content, isUser = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `chatbot-message ${isUser ? 'user' : 'bot'}`;
  
  const contentDiv = document.createElement('div');
  contentDiv.className = 'chatbot-message-content';
  
  // Format with proper line breaks
  let formatted = content.trim();
  
  // Detect and style section headers (supports ──, ───, ━━, ━━━, ==, ===)
  if (formatted.includes('─') || formatted.includes('━') || /={2,}/.test(formatted)) {
    const lines = formatted.split('\n');
    let htmlContent = '';
    
    lines.forEach(line => {
      line = line.trim();
      
      // Section header detection - matches 2+ separator chars on each side
      if (/^[─━=]{2,}.*[─━=]{2,}$/.test(line)) {
        const title = line.replace(/[─━=]/g, '').trim();
        htmlContent += `<div class="msg-section-header">${title}</div>`;
      } else if (line) {
        htmlContent += `<div>${line}</div>`;
      } else {
        htmlContent += '<br>';
      }
    });
    
    contentDiv.innerHTML = htmlContent;
  } else {
    contentDiv.textContent = formatted;
  }
  
  messageDiv.appendChild(contentDiv);
  document.getElementById('chatbotMessages').appendChild(messageDiv);
  document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
}

function showTypingIndicator() {
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chatbot-message bot';
  typingDiv.id = 'typingIndicator';
  
  const indicator = document.createElement('div');
  indicator.className = 'typing-indicator chatbot-message-content';
  indicator.innerHTML = '<span></span><span></span><span></span>';
  
  typingDiv.appendChild(indicator);
  document.getElementById('chatbotMessages').appendChild(typingDiv);
  document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
}

function removeTypingIndicator() {
  const indicator = document.getElementById('typingIndicator');
  if (indicator) indicator.remove();
}

document.getElementById('chatbotSend')?.addEventListener('click', async () => {
  const chatbotInput = document.getElementById('chatbotInput');
  const chatbotSend = document.getElementById('chatbotSend');
  const message = chatbotInput.value.trim();
  if (!message) return;
  
  addChatMessage(message, true);
  chatHistory.push({ role: 'user', content: message });
  
  chatbotInput.value = '';
  chatbotSend.disabled = true;
  chatbotInput.disabled = true;
  
  showTypingIndicator();
  
  try {
    const response = await fetch('/api/chatbot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: message,
        time_range: '24h',
        history: chatHistory.slice(-10)
      })
    });
    
    if (!response.ok) throw new Error('Chatbot request failed');
    
    const data = await response.json();
    removeTypingIndicator();
    addChatMessage(data.response, false);
    chatHistory.push({ role: 'assistant', content: data.response });
  } catch (error) {
    console.error('Chatbot error:', error);
    removeTypingIndicator();
    addChatMessage('Sorry, I encountered an error. Please try again.', false);
  } finally {
    chatbotSend.disabled = false;
    chatbotInput.disabled = false;
    chatbotInput.focus();
  }
});

// Allow Enter key to send
document.getElementById('chatbotInput')?.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('chatbotSend')?.click();
  }
});

// Chatbot Toggle and Close Handlers
document.getElementById('chatbotToggle')?.addEventListener('click', () => {
  const chatbotWindow = document.getElementById('chatbotWindow');
  if (chatbotWindow) {
    chatbotWindow.classList.toggle('open');
    if (chatbotWindow.classList.contains('open')) {
      document.getElementById('chatbotInput')?.focus();
    }
  }
});

document.getElementById('chatbotClose')?.addEventListener('click', () => {
  const chatbotWindow = document.getElementById('chatbotWindow');
  if (chatbotWindow) {
    chatbotWindow.classList.remove('open');
  }
});

document.getElementById('adminFilter')
  ?.addEventListener('change', (e) => {
    const filter = e.target.value;
    redrawAdminRecent();
    const filterLabel = filter === 'ALL' ? 'all transactions' : filter === 'BLOCK' ? 'blocked transactions' : filter === 'DELAY' ? 'delayed transactions' : 'allowed transactions';
    const count = filter === 'ALL' ? adminTxCache.length : adminTxCache.filter(tx => (tx.action || '').toUpperCase() === filter).length;
    showToast('info', `Now displaying ${count} ${filterLabel}`, 'Filter Applied');
  });

document.getElementById('timeFilter')
  ?.addEventListener('change', async (e) => {
    const timeRange = e.target.value;
    const rangeLabel = timeRange === '1h' ? 'last hour' : timeRange === '24h' ? 'last 24 hours' : timeRange === '7d' ? 'last 7 days' : 'last 30 days';
    await fetchRecent();
    showToast('info', `Transaction table updated with data from ${rangeLabel} (${adminTxCache.length} records loaded)`, 'Time Range Changed');
  });

// Model Accuracy Info Modal
document.getElementById('modelAccuracyInfoBtn')?.addEventListener('click', () => {
  const modal = document.getElementById('modelAccuracyModal');
  if (modal) {
    modal.style.display = 'flex';
  }
});

document.getElementById('closeModelAccuracyModal')?.addEventListener('click', () => {
  const modal = document.getElementById('modelAccuracyModal');
  if (modal) {
    modal.style.display = 'none';
  }
});

document.getElementById('modelAccuracyModal')?.addEventListener('click', (e) => {
  if (e.target.id === 'modelAccuracyModal') {
    e.target.style.display = 'none';
  }
});

// Export Audit Trail - Show Modal
document.getElementById('exportAuditBtn')?.addEventListener('click', () => {
  const modal = document.getElementById('exportAuditModal');
  if (modal) {
    modal.style.display = 'flex';
    // Set default dates
    const now = new Date();
    const start = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    document.getElementById('auditExportEndDate').value = now.toISOString().slice(0, 16);
    document.getElementById('auditExportStartDate').value = start.toISOString().slice(0, 16);
    showToast('info', 'Select your preferred time range and format to export audit logs', 'Export Options');
  }
});

// Handle custom date range visibility for audit export - ensure proper setup
function setupAuditDateRangeListener() {
  const timeRangeSelect = document.getElementById('auditExportTimeRange');
  const customRange = document.getElementById('auditCustomDateRange');
  
  if (timeRangeSelect && customRange) {
    // Set initial visibility
    customRange.style.display = timeRangeSelect.value === 'custom' ? 'block' : 'none';
    
    // Add change listener
    timeRangeSelect.addEventListener('change', (e) => {
      customRange.style.display = e.target.value === 'custom' ? 'block' : 'none';
    });
  }
}

// Setup on DOM ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupAuditDateRangeListener);
} else {
  setupAuditDateRangeListener();
}

// Audit Export Function
async function performAuditExport() {
  const pad2 = (n) => String(n).padStart(2, '0');
  const formatDateTime = (value) => {
    if (!value) return '';
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return String(value).trim();
    return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())} | ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  };
  const clean = (value) => (value === null || value === undefined) ? '' : String(value).replace(/\s+/g, ' ').trim();
  const num = (value, digits = 2) => {
    const n = Number(value);
    return Number.isFinite(n) ? n.toFixed(digits) : '';
  };

  const exportBtn = document.getElementById('auditExportSubmit');
  const setLoading = (isLoading) => {
    if (!exportBtn) return;
    exportBtn.disabled = isLoading;
    exportBtn.classList.toggle('loading', isLoading);
    exportBtn.setAttribute('aria-busy', String(isLoading));
    const textEl = exportBtn.querySelector('.export-btn-text');
    if (textEl) textEl.textContent = isLoading ? 'Exporting...' : 'Export';
  };

  setLoading(true);
  try {
    // Get selected options
    const timeRange = document.getElementById('auditExportTimeRange').value;
    const format = document.getElementById('auditExportFormat').value;
    
    // Calculate date range - create new instance so we don't modify the real Date()
    const endDate = new Date();
    let startDate = new Date(endDate.getTime()); // Create a copy
    
    if (timeRange === '24h') {
      startDate.setHours(startDate.getHours() - 24);
    } else if (timeRange === '7d') {
      startDate.setDate(startDate.getDate() - 7);
    } else if (timeRange === '30d') {
      startDate.setDate(startDate.getDate() - 30);
    } else if (timeRange === '90d') {
      startDate.setDate(startDate.getDate() - 90);
    } else if (timeRange === 'custom') {
      startDate = new Date(document.getElementById('auditExportStartDate').value);
    }

    const [logsRes, txRes] = await Promise.all([
      fetch(`/admin/logs?limit=99999&_=${Date.now()}`),
      fetch(`/recent-transactions?limit=99999&time_range=${timeRange}&_=${Date.now()}`)
    ]);

    if (!logsRes.ok) throw new Error('Failed to fetch admin logs');
    const logsData = await logsRes.json();
    let logs = logsData.logs || [];

    // Filter by date range
    logs = logs.filter(log => {
      const logDate = new Date(log.created_at || log.time || log.timestamp);
      return logDate >= startDate && logDate <= endDate;
    });

    const txData = txRes.ok ? await txRes.json() : { transactions: [] };
    const txList = txData.transactions || [];
    const txMap = new Map(txList.map(t => [t.tx_id, t]));

    if (!logs.length) {
      alert('No audit logs to export for the selected time range');
      return;
    }

    const headers = [
      'Timestamp',
      'Admin User',
      'Action',
      'Transaction ID',
      'User ID',
      'Amount',
      'Channel',
      'Risk Score',
      'Confidence Level',
      'Recipient VPA',
      'Device ID'
    ];

    const rows = [headers];
    logs.forEach(log => {
      const tx = txMap.get(log.tx_id) || {};

      rows.push([
        formatDateTime(log.created_at || log.time || log.timestamp),
        clean(log.admin_username || 'system'),
        clean((log.action || '').toUpperCase()),
        clean(log.tx_id),
        clean(log.user_id || tx.user_id),
        num(tx.amount, 2),
        clean(tx.channel),
        num(tx.risk_score ?? tx.risk, 4),
        clean((tx.confidence_level || '').toUpperCase()),
        clean(tx.recipient_vpa),
        clean(tx.device_id)
      ]);
    });

    let content, fileName, mimeType;
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '_');

    if (format === 'csv') {
      const csvBody = rows.map(r => r.map(c => {
        const escaped = String(c ?? '').replace(/"/g, '""');
        return `"${escaped}"`;
      }).join(',')).join('\n');
      content = `\ufeff${csvBody}`;
      fileName = `admin_audit_trail_${timestamp}.csv`;
      mimeType = 'text/csv;charset=utf-8;';
    } else if (format === 'json') {
      const jsonData = rows.slice(1).map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = row[i]);
        return obj;
      });
      content = JSON.stringify(jsonData, null, 2);
      fileName = `admin_audit_trail_${timestamp}.json`;
      mimeType = 'application/json;charset=utf-8;';
    } else if (format === 'txt') {
      const txtBody = rows.map(r => r.join('\t')).join('\n');
      content = txtBody;
      fileName = `admin_audit_trail_${timestamp}.txt`;
      mimeType = 'text/plain;charset=utf-8;';
    } else if (format === 'xlsx') {
      const csvBody = rows.map(r => r.map(c => {
        const escaped = String(c ?? '').replace(/"/g, '""');
        return `"${escaped}"`;
      }).join(',')).join('\n');
      content = csvBody;
      fileName = `admin_audit_trail_${timestamp}.xlsx`;
      mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8;';
    }

    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);

    document.getElementById('exportAuditModal').style.display = 'none';
    showToast('success', `Successfully exported ${logs.length} audit log entries to ${fileName}`, 'Export Complete');
  } catch (e) {
    console.error('Audit export failed:', e);
    alert('Export failed. Please try again.');
  } finally {
    setLoading(false);
  }
}


/* ========== THRESHOLD TUNING PANEL ========== */

// Default thresholds (fixed defaults for restoration)
const DEFAULT_THRESHOLDS = {
  allowMax: 0.30,
  delayMax: 0.60,
  blockMin: 0.60,
  lowConfidence: 0.40,
  mediumConfidence: 0.70,
  highConfidence: 0.85,
  rfWeight: 35,
  xgbWeight: 40,
  isoWeight: 25
};

const SERVER_THRESHOLDS = {{ initial_thresholds | tojson | safe }};

// Current thresholds in memory
let currentThresholds = { ...DEFAULT_THRESHOLDS, ...(SERVER_THRESHOLDS || {}) };
let activePresetSlot = null; // Track which preset is currently active
let presets = {}; // Store loaded presets

function thresholdsEqual(a, b) {
  if (!a || !b) return false;
  const floatKeys = ['allowMax', 'delayMax', 'blockMin', 'lowConfidence', 'mediumConfidence', 'highConfidence'];
  const intKeys = ['rfWeight', 'xgbWeight', 'isoWeight'];
  const epsilon = 0.001;

  for (const key of floatKeys) {
    if (typeof a[key] !== 'number' || typeof b[key] !== 'number') return false;
    if (Math.abs(a[key] - b[key]) > epsilon) return false;
  }

  for (const key of intKeys) {
    if (typeof a[key] !== 'number' || typeof b[key] !== 'number') return false;
    if (a[key] !== b[key]) return false;
  }

  return true;
}

function updatePresetBadge() {
  const badge = document.getElementById('presetStatusBadge');
  if (!badge) return;

  let label = 'Custom';
  let className = 'preset-status-badge preset-status-custom';

  if (thresholdsEqual(currentThresholds, DEFAULT_THRESHOLDS)) {
    label = 'Default';
    className = 'preset-status-badge preset-status-default';
  } else {
    let matchSlot = null;
    if (activePresetSlot && presets[activePresetSlot] && thresholdsEqual(currentThresholds, presets[activePresetSlot].config)) {
      matchSlot = activePresetSlot;
    } else {
      for (const [slot, preset] of Object.entries(presets)) {
        if (preset?.config && thresholdsEqual(currentThresholds, preset.config)) {
          matchSlot = Number(slot);
          break;
        }
      }
    }

    if (matchSlot && presets[matchSlot]) {
      label = presets[matchSlot].name || `Preset ${matchSlot}`;
      className = 'preset-status-badge preset-status-preset';
    }
  }

  badge.textContent = label;
  badge.className = className;
}

function applyThresholdsToUI(nextThresholds) {
  const incoming = nextThresholds && typeof nextThresholds === 'object' ? nextThresholds : {};
  currentThresholds = { ...DEFAULT_THRESHOLDS, ...incoming };

  if ((incoming.allowMax === undefined || incoming.allowMax === null) && typeof incoming.delay === 'number') {
    currentThresholds.allowMax = Number(incoming.delay);
  }
  if ((incoming.blockMin === undefined || incoming.blockMin === null) && typeof incoming.block === 'number') {
    currentThresholds.blockMin = Number(incoming.block);
  }

  currentThresholds.allowMax = Number(currentThresholds.allowMax);
  currentThresholds.delayMax = Number(currentThresholds.delayMax);
  currentThresholds.blockMin = Number(currentThresholds.blockMin);
  currentThresholds.lowConfidence = Number(currentThresholds.lowConfidence);
  currentThresholds.mediumConfidence = Number(currentThresholds.mediumConfidence);
  currentThresholds.highConfidence = Number(currentThresholds.highConfidence);
  currentThresholds.rfWeight = parseInt(currentThresholds.rfWeight);
  currentThresholds.xgbWeight = parseInt(currentThresholds.xgbWeight);
  currentThresholds.isoWeight = parseInt(currentThresholds.isoWeight);

  if (document.getElementById('allowMaxSlider')) {
    document.getElementById('allowMaxSlider').value = currentThresholds.allowMax;
    document.getElementById('allowMaxVal').textContent = currentThresholds.allowMax.toFixed(2);
  }
  if (document.getElementById('delayMaxSlider')) {
    document.getElementById('delayMaxSlider').value = currentThresholds.delayMax;
    document.getElementById('delayMaxVal').textContent = currentThresholds.delayMax.toFixed(2);
  }
  if (document.getElementById('blockMinSlider')) {
    document.getElementById('blockMinSlider').value = currentThresholds.blockMin;
    document.getElementById('blockMinVal').textContent = currentThresholds.blockMin.toFixed(2);
  }
  if (document.getElementById('lowConfSlider')) {
    document.getElementById('lowConfSlider').value = currentThresholds.lowConfidence;
    document.getElementById('lowConfVal').textContent = currentThresholds.lowConfidence.toFixed(2);
  }
  if (document.getElementById('mediumConfSlider')) {
    document.getElementById('mediumConfSlider').value = currentThresholds.mediumConfidence;
    document.getElementById('mediumConfVal').textContent = currentThresholds.mediumConfidence.toFixed(2);
  }
  if (document.getElementById('rfWeightSlider')) {
    document.getElementById('rfWeightSlider').value = currentThresholds.rfWeight;
    document.getElementById('rfWeightVal').textContent = currentThresholds.rfWeight + '%';
  }
  if (document.getElementById('xgbWeightSlider')) {
    document.getElementById('xgbWeightSlider').value = currentThresholds.xgbWeight;
    document.getElementById('xgbWeightVal').textContent = currentThresholds.xgbWeight + '%';
  }
  if (document.getElementById('isoWeightSlider')) {
    document.getElementById('isoWeightSlider').value = currentThresholds.isoWeight;
    document.getElementById('isoWeightVal').textContent = currentThresholds.isoWeight + '%';
  }

  updateWeightSum();
  updateLivePreview();
  updatePresetBadge();
}

async function loadCurrentThresholds() {
  try {
    const response = await fetch('/admin/get-thresholds');
    if (!response.ok) throw new Error('Failed to load thresholds');
    const data = await response.json();
    applyThresholdsToUI(data?.thresholds || DEFAULT_THRESHOLDS);
  } catch (e) {
    console.error('Error loading thresholds:', e);
    applyThresholdsToUI(currentThresholds);
  }
}

// Load presets from server on page load
async function loadPresets() {
  try {
    const response = await fetch('/admin/get-presets');
    if (!response.ok) throw new Error('Failed to load presets');
    
    const data = await response.json();
    presets = data.presets || {};
    renderPresetCards();
    updatePresetBadge();
  } catch (e) {
    console.error('Error loading presets:', e);
    renderPresetCards(); // Render empty cards
    updatePresetBadge();
  }
}

// Render preset cards
function renderPresetCards() {
  const container = document.getElementById('presetCardsContainer');
  if (!container) return;
  
  container.innerHTML = '';
  
  for (let slot = 1; slot <= 3; slot++) {
    const preset = presets[slot];
    const isEmpty = !preset;
    const isActive = activePresetSlot === slot;
    
    const card = document.createElement('div');
    card.className = `preset-card ${isEmpty ? 'empty' : ''} ${isActive ? 'active' : ''}`;
    card.dataset.slot = slot;
    
    const defaultName = `Preset ${slot}`;
    const presetName = preset ? preset.name : defaultName;
    const updatedAt = preset && preset.updated_at ? formatTimestampUTC(preset.updated_at) : 'Not saved';
    
    card.innerHTML = `
      <div class="preset-card-header">
        <div class="preset-card-name" contenteditable="false" data-slot="${slot}" data-original="${presetName}">
          ${presetName}
        </div>
        <div class="preset-card-actions">
          ${!isEmpty ? `<button class="preset-card-btn" onclick="deletePreset(${slot})" title="Delete">🗑️</button>` : ''}
        </div>
      </div>
      <div class="preset-card-info">
        ${isEmpty ? '💾 Empty slot' : `📅 ${updatedAt}`}
      </div>
      ${!isEmpty ? `<div class="preset-card-config">Allow: ${preset.config.allowMax.toFixed(2)} | Block: ${preset.config.blockMin.toFixed(2)}</div>` : ''}
    `;
    
    // Click to load preset
    if (!isEmpty) {
      card.addEventListener('click', (e) => {
        if (!e.target.classList.contains('preset-card-name') && !e.target.classList.contains('preset-card-btn')) {
          loadPreset(slot);
        }
      });
    }
    
    // Double-click name to edit
    const nameEl = card.querySelector('.preset-card-name');
    nameEl.addEventListener('dblclick', () => {
      nameEl.contentEditable = 'true';
      nameEl.classList.add('editing');
      nameEl.focus();
      document.execCommand('selectAll', false, null);
    });
    
    nameEl.addEventListener('blur', () => {
      nameEl.contentEditable = 'false';
      nameEl.classList.remove('editing');
      const newName = nameEl.textContent.trim();
      if (newName && newName !== nameEl.dataset.original && presets[slot]) {
        updatePresetName(slot, newName);
      } else {
        nameEl.textContent = nameEl.dataset.original;
      }
    });
    
    nameEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        nameEl.blur();
      } else if (e.key === 'Escape') {
        nameEl.textContent = nameEl.dataset.original;
        nameEl.blur();
      }
    });
    
    container.appendChild(card);
  }
}

// Toggle preset section
function togglePresets() {
  const content = document.getElementById('presetsContent');
  const icon = document.getElementById('presetsToggleIcon');
  
  if (content.style.display === 'none') {
    content.style.display = 'block';
    icon.style.transform = 'rotate(0deg)';
    showToast('info', 'Manage saved threshold configurations - Load, save, or delete presets', 'Preset Manager Opened');
  } else {
    content.style.display = 'none';
    icon.style.transform = 'rotate(-90deg)';
  }
}

// Save preset
document.getElementById('savePresetBtn')?.addEventListener('click', async () => {
  const selectEl = document.getElementById('presetSlotSelect');
  if (!selectEl) {
    showToast('error', 'Preset dropdown not found - Please refresh the page and try again', 'UI Error');
    return;
  }
  
  const slotValue = selectEl.value;
  const slot = parseInt(slotValue);
  
  console.log('Save preset - Select element found:', !!selectEl);
  console.log('Save preset - Select value (string):', slotValue, 'Parsed slot (int):', slot);
  console.log('Save preset - Validation: !slot=', !slot, 'isNaN(slot)=', isNaN(slot), 'slot < 1=', slot < 1, 'slot > 3=', slot > 3);
  
  if (!slot || isNaN(slot) || slot < 1 || slot > 3) {
    showToast('error', `Invalid preset slot "${slotValue}" - Please select a valid preset (1, 2, or 3)`, 'Invalid Selection');
    return;
  }
  
  const config = { ...currentThresholds };
  
  // Get preset name if exists, otherwise use default
  const existingName = presets[slot] ? presets[slot].name : `Preset ${slot}`;
  
  const payloadToSend = {
    preset_slot: slot,
    preset_name: existingName,
    config: config
  };
  console.log('Save preset - Payload to send:', payloadToSend);
  
  try {
    const response = await fetch('/admin/save-preset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payloadToSend)
    });
    
    const responseText = await response.text();
    console.log('Save response status:', response.status, 'body:', responseText);
    
    if (!response.ok) {
      throw new Error(`Server error: ${response.status} - ${responseText}`);
    }
    
    const data = JSON.parse(responseText);
    showToast('success', `${existingName} saved with current configuration (Allow: ≤${currentThresholds.allowMax.toFixed(2)}, Block: ≥${currentThresholds.blockMin.toFixed(2)})`, 'Preset Saved');
    
    // Reload presets
    await loadPresets();
    activePresetSlot = slot;
    renderPresetCards();
    updatePresetBadge();
  } catch (e) {
    console.error('Error saving preset:', e);
    showToast('error', `Could not save preset configuration - ${e.message}`, 'Save Failed');
  }
});

// Load preset
async function loadPreset(slot) {
  const preset = presets[slot];
  if (!preset) {
    showToast('error', `Preset slot ${slot} is empty - Save current configuration to this slot first`, 'Empty Preset');
    return;
  }
  
  try {
    currentThresholds = { ...preset.config };
    
    // Update all sliders and displays
    document.getElementById('allowMaxSlider').value = currentThresholds.allowMax;
    document.getElementById('allowMaxVal').textContent = currentThresholds.allowMax.toFixed(2);
    
    document.getElementById('delayMaxSlider').value = currentThresholds.delayMax;
    document.getElementById('delayMaxVal').textContent = currentThresholds.delayMax.toFixed(2);
    
    document.getElementById('blockMinSlider').value = currentThresholds.blockMin;
    document.getElementById('blockMinVal').textContent = currentThresholds.blockMin.toFixed(2);
    
    document.getElementById('lowConfSlider').value = currentThresholds.lowConfidence;
    document.getElementById('lowConfVal').textContent = currentThresholds.lowConfidence.toFixed(2);
    
    document.getElementById('mediumConfSlider').value = currentThresholds.mediumConfidence;
    document.getElementById('mediumConfVal').textContent = currentThresholds.mediumConfidence.toFixed(2);
    
    document.getElementById('rfWeightSlider').value = currentThresholds.rfWeight;
    document.getElementById('rfWeightVal').textContent = currentThresholds.rfWeight + '%';
    
    document.getElementById('xgbWeightSlider').value = currentThresholds.xgbWeight;
    document.getElementById('xgbWeightVal').textContent = currentThresholds.xgbWeight + '%';
    
    document.getElementById('isoWeightSlider').value = currentThresholds.isoWeight;
    document.getElementById('isoWeightVal').textContent = currentThresholds.isoWeight + '%';
    
    updateWeightSum();
    updateLivePreview();
    
    activePresetSlot = slot;
    renderPresetCards();
    updatePresetBadge();
    
    showToast('info', `"${preset.name}" selected - Click "Apply Changes" to activate these thresholds`, 'Preset Selected');
  } catch (e) {
    console.error('Error loading preset:', e);
    showToast('error', `Could not load preset "${preset.name}" - ${e.message}`, 'Load Failed');
  }
}

// Update preset name
async function updatePresetName(slot, newName) {
  const preset = presets[slot];
  if (!preset) {
    showToast('error', `Cannot rename - Preset slot ${slot} does not exist`, 'Preset Not Found');
    return;
  }
  
  const oldName = preset.name;
  
  try {
    const response = await fetch('/admin/save-preset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        preset_slot: slot,
        preset_name: newName,
        config: preset.config
      })
    });
    
    const responseText = await response.text();
    
    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }
    
    presets[slot].name = newName;
    renderPresetCards();
    showToast('success', `Preset renamed from "${oldName}" to "${newName}"`, 'Preset Renamed');
  } catch (e) {
    console.error('Error updating preset name:', e);
    showToast('error', `❌ Failed to rename preset: ${e.message}`);
  }
}

// Delete preset
async function deletePreset(slot) {
  const presetName = presets[slot] ? presets[slot].name : `Preset ${slot}`;
  
  if (!confirm(`Are you sure you want to permanently delete "${presetName}"? This cannot be undone.`)) return;
  
  try {
    const response = await fetch('/admin/delete-preset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ preset_slot: slot })
    });
    
    const responseText = await response.text();
    
    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }
    
    delete presets[slot];
    if (activePresetSlot === slot) activePresetSlot = null;
    renderPresetCards();
    updatePresetBadge();
    showToast('success', `"${presetName}" has been permanently deleted`, 'Preset Deleted');
  } catch (e) {
    console.error('Error deleting preset:', e);
    showToast('error', `Could not delete preset "${presetName}" - ${e.message}`, 'Delete Failed');
  }
}

// Initialize presets on page load
loadPresets();

// Risk Score Sliders
document.getElementById('allowMaxSlider')?.addEventListener('input', (e) => {
  currentThresholds.allowMax = parseFloat(e.target.value);
  document.getElementById('allowMaxVal').textContent = currentThresholds.allowMax.toFixed(2);
  validateThresholds();
  updateLivePreview();
  updatePresetBadge();
});

document.getElementById('delayMaxSlider')?.addEventListener('input', (e) => {
  currentThresholds.delayMax = parseFloat(e.target.value);
  document.getElementById('delayMaxVal').textContent = currentThresholds.delayMax.toFixed(2);
  validateThresholds();
  updateLivePreview();
  updatePresetBadge();
});

document.getElementById('blockMinSlider')?.addEventListener('input', (e) => {
  currentThresholds.blockMin = parseFloat(e.target.value);
  document.getElementById('blockMinVal').textContent = currentThresholds.blockMin.toFixed(2);
  validateThresholds();
  updateLivePreview();
  updatePresetBadge();
});

// Confidence Sliders
document.getElementById('lowConfSlider')?.addEventListener('input', (e) => {
  currentThresholds.lowConfidence = parseFloat(e.target.value);
  document.getElementById('lowConfVal').textContent = currentThresholds.lowConfidence.toFixed(2);
  validateThresholds();
  updatePresetBadge();
});

document.getElementById('mediumConfSlider')?.addEventListener('input', (e) => {
  currentThresholds.mediumConfidence = parseFloat(e.target.value);
  document.getElementById('mediumConfVal').textContent = currentThresholds.mediumConfidence.toFixed(2);
  validateThresholds();
  updatePresetBadge();
});

// Weight Sliders
document.getElementById('rfWeightSlider')?.addEventListener('input', (e) => {
  currentThresholds.rfWeight = parseInt(e.target.value);
  document.getElementById('rfWeightVal').textContent = currentThresholds.rfWeight + '%';
  updateWeightSum();
  updatePresetBadge();
});

document.getElementById('xgbWeightSlider')?.addEventListener('input', (e) => {
  currentThresholds.xgbWeight = parseInt(e.target.value);
  document.getElementById('xgbWeightVal').textContent = currentThresholds.xgbWeight + '%';
  updateWeightSum();
  updatePresetBadge();
});

document.getElementById('isoWeightSlider')?.addEventListener('input', (e) => {
  currentThresholds.isoWeight = parseInt(e.target.value);
  document.getElementById('isoWeightVal').textContent = currentThresholds.isoWeight + '%';
  updateWeightSum();
  updatePresetBadge();
});

function updateWeightSum() {
  const sum = currentThresholds.rfWeight + currentThresholds.xgbWeight + currentThresholds.isoWeight;
  const weightSumEl = document.getElementById('weightSum');
  if (weightSumEl) {
    weightSumEl.textContent = sum + '%';
    if (sum === 100) {
      weightSumEl.style.color = '#10b981';
    } else {
      weightSumEl.style.color = '#ef4444';
    }
  }
}

function validateThresholds() {
  const issues = [];
  
  // Guardrail: BLOCK threshold cannot go below 0.40
  if (currentThresholds.blockMin < 0.40) {
    issues.push('⚠️ BLOCK threshold cannot be below 0.40 (safety guardrail)');
    currentThresholds.blockMin = 0.40;
  }
  
  // Guardrail: ALLOW threshold cannot go above 0.50
  if (currentThresholds.allowMax > 0.50) {
    issues.push('⚠️ ALLOW threshold cannot exceed 0.50 (safety guardrail)');
    currentThresholds.allowMax = 0.50;
  }
  
  // Guardrail: Logical order
  if (currentThresholds.allowMax >= currentThresholds.blockMin) {
    issues.push('⚠️ ALLOW max must be less than BLOCK min');
    currentThresholds.blockMin = Math.min(1.0, currentThresholds.allowMax + 0.10);
  }
  
  if (issues.length > 0) {
    showToast('warning', issues.join(' • '), 'Thresholds Auto-Corrected');
  }
  
  // Update display after validation
  document.getElementById('allowMaxVal').textContent = currentThresholds.allowMax.toFixed(2);
  document.getElementById('blockMinVal').textContent = currentThresholds.blockMin.toFixed(2);
  document.getElementById('allowMaxSlider').value = currentThresholds.allowMax;
  document.getElementById('blockMinSlider').value = currentThresholds.blockMin;
}

function updateLivePreview() {
  // Simulate how last 100 transactions would be classified
  let allowCount = 0, delayCount = 0, blockCount = 0;
  
  // Use first 100 transactions from cache
  const previewTxs = adminTxCache.slice(0, 100);
  
  previewTxs.forEach(tx => {
    const score = tx.risk_score || 0;
    if (score <= currentThresholds.allowMax) {
      allowCount++;
    } else if (score <= currentThresholds.blockMin) {
      delayCount++;
    } else {
      blockCount++;
    }
  });
  
  document.getElementById('previewAllow').textContent = allowCount;
  document.getElementById('previewDelay').textContent = delayCount;
  document.getElementById('previewBlock').textContent = blockCount;
}

// Reset to defaults
document.getElementById('resetThresholdBtn')?.addEventListener('click', () => {
  if (!confirm('Are you sure? This will restore ALL thresholds to defaults.')) return;
  
  currentThresholds = { ...DEFAULT_THRESHOLDS };
  
  document.getElementById('allowMaxSlider').value = DEFAULT_THRESHOLDS.allowMax;
  document.getElementById('delayMaxSlider').value = DEFAULT_THRESHOLDS.delayMax;
  document.getElementById('blockMinSlider').value = DEFAULT_THRESHOLDS.blockMin;
  document.getElementById('lowConfSlider').value = DEFAULT_THRESHOLDS.lowConfidence;
  document.getElementById('mediumConfSlider').value = DEFAULT_THRESHOLDS.mediumConfidence;
  document.getElementById('rfWeightSlider').value = DEFAULT_THRESHOLDS.rfWeight;
  document.getElementById('xgbWeightSlider').value = DEFAULT_THRESHOLDS.xgbWeight;
  document.getElementById('isoWeightSlider').value = DEFAULT_THRESHOLDS.isoWeight;
  
  document.getElementById('allowMaxVal').textContent = DEFAULT_THRESHOLDS.allowMax.toFixed(2);
  document.getElementById('delayMaxVal').textContent = DEFAULT_THRESHOLDS.delayMax.toFixed(2);
  document.getElementById('blockMinVal').textContent = DEFAULT_THRESHOLDS.blockMin.toFixed(2);
  document.getElementById('lowConfVal').textContent = DEFAULT_THRESHOLDS.lowConfidence.toFixed(2);
  document.getElementById('mediumConfVal').textContent = DEFAULT_THRESHOLDS.mediumConfidence.toFixed(2);
  document.getElementById('rfWeightVal').textContent = DEFAULT_THRESHOLDS.rfWeight + '%';
  document.getElementById('xgbWeightVal').textContent = DEFAULT_THRESHOLDS.xgbWeight + '%';
  document.getElementById('isoWeightVal').textContent = DEFAULT_THRESHOLDS.isoWeight + '%';
  
  updateWeightSum();
  updateLivePreview();
  activePresetSlot = null;
  updatePresetBadge();
  renderPresetCards(); // Deselect any highlighted preset
  
  showToast('success', 'All thresholds reset to factory defaults - Click "Apply Changes" to activate', 'Defaults Restored');
});

// Apply threshold changes
document.getElementById('applyThresholdBtn')?.addEventListener('click', async () => {
  // Final validation
  const sum = currentThresholds.rfWeight + currentThresholds.xgbWeight + currentThresholds.isoWeight;
  if (sum !== 100) {
    showToast('error', `Model weights currently sum to ${sum}% - Please adjust so they total exactly 100%`, 'Invalid Weights');
    return;
  }
  
  if (currentThresholds.allowMax >= currentThresholds.blockMin) {
    showToast('error', `Allow threshold (${currentThresholds.allowMax.toFixed(2)}) must be less than Block threshold (${currentThresholds.blockMin.toFixed(2)})`, 'Invalid Configuration');
    return;
  }
  
  try {
    const response = await fetch('/admin/update-thresholds', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(currentThresholds)
    });
    
    if (response.ok) {
      const presetInfo = activePresetSlot ? ` from "${presets[activePresetSlot]?.name || 'Preset ' + activePresetSlot}"` : '';
      showToast('success', `Configuration applied${presetInfo} - All new transactions will use updated thresholds (Allow: ≤${currentThresholds.allowMax.toFixed(2)}, Block: ≥${currentThresholds.blockMin.toFixed(2)})`, 'Thresholds Updated');
      
      // Collapse presets section after applying changes
      const presetsContent = document.getElementById('presetsContent');
      const presetsIcon = document.getElementById('presetsToggleIcon');
      if (presetsContent && presetsContent.style.display !== 'none') {
        presetsContent.style.display = 'none';
        if (presetsIcon) presetsIcon.style.transform = 'rotate(-90deg)';
      }
      
      // Log this admin action
      const adminLogs = document.getElementById('admin_logs');
      const log = document.createElement('div');
      log.className = 'admin-log-item';
      log.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="text-xs font-mono font-semibold">THRESHOLD UPDATE</div>
          <div class="flex items-center gap-2">
            <span class="text-[10px] text-gray-500">${formatTimestampUTC(new Date().toISOString())}</span>
            <span class="action-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">CONFIG</span>
          </div>
        </div>
        <div class="text-xs text-gray-600 mt-1">Risk: ${currentThresholds.allowMax.toFixed(2)}-${currentThresholds.blockMin.toFixed(2)} | Weights: RF ${currentThresholds.rfWeight}% XGB ${currentThresholds.xgbWeight}% ISO ${currentThresholds.isoWeight}%</div>
      `;
      adminLogs.prepend(log);
    } else {
      const errorData = await response.json();
      showToast('error', errorData.detail || 'Server rejected the threshold configuration - please check your values and try again', 'Update Failed');
    }
  } catch (error) {
    console.error('Error applying thresholds:', error);
    showToast('error', 'Network error while updating thresholds - ' + error.message, 'Connection Error');
  }
});

// Initialize threshold panel on page load
document.addEventListener('DOMContentLoaded', () => {
  applyThresholdsToUI(SERVER_THRESHOLDS || DEFAULT_THRESHOLDS);
  loadCurrentThresholds();
});

</script>

<!-- Export Audit Trail Modal -->
<div id="exportAuditModal" style="display: none;">
  <div class="modal-content export-modal">
    <div class="export-modal-header">
      <div>
        <h2 class="export-modal-title">📤 Export Audit Trail</h2>
        <div class="export-modal-subtitle">Download admin activity logs securely</div>
      </div>
      <button class="export-modal-close" onclick="document.getElementById('exportAuditModal').style.display='none'">&times;</button>
    </div>
    <div class="export-modal-body">
      <div class="export-form-group">
        <label>Time Range</label>
        <div class="select-wrapper">
          <select id="auditExportTimeRange" class="export-control">
            <option value="24h">Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
            <option value="30d">Last 30 Days</option>
            <option value="90d">Last 90 Days</option>
            <option value="custom">Custom Date Range</option>
          </select>
          <span class="select-arrow">▼</span>
        </div>
      </div>

      <div id="auditCustomDateRange" style="display: none;" class="export-form-group">
        <label>From Date</label>
        <input type="datetime-local" id="auditExportStartDate" class="export-control">
        <label style="margin-top: 10px;">To Date</label>
        <input type="datetime-local" id="auditExportEndDate" class="export-control">
      </div>

      <div class="export-form-group">
        <label>File Format</label>
        <div class="select-wrapper">
          <select id="auditExportFormat" class="export-control">
            <option value="csv">CSV (Excel)</option>
            <option value="json">JSON (Structured)</option>
            <option value="txt">TXT (Delimited)</option>
            <option value="xlsx">XLSX (Excel Workbook)</option>
          </select>
          <span class="select-arrow">▼</span>
        </div>
      </div>
    </div>
    <div class="export-modal-footer">
      <button class="export-btn-secondary" onclick="document.getElementById('exportAuditModal').style.display='none'">Cancel</button>
      <button id="auditExportSubmit" class="export-btn-primary" onclick="performAuditExport()">
        <span class="export-btn-text">Export</span>
        <span class="export-spinner" aria-hidden="true"></span>
      </button>
    </div>
  </div>
</div>

  <!-- Footer -->
  <footer style="margin-top: 60px; padding: 32px 0; border-top: 1px solid #e5e7eb; background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.02));">
    <div class="max-w-7xl mx-auto px-6">
      <div style="display: flex; flex-direction: column; gap: 24px; align-items: center; text-align: center;">
        <div>
          <h3 style="font-size: 16px; font-weight: 600; color: #374151; margin-bottom: 12px;">Connect With Us</h3>
          <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;">
            <a href="mailto:teamfdt2@gmail.com" class="footer-social-link email" title="Email" aria-label="Email" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #fee2e2, #fecaca); color: #991b1b; text-decoration: none; font-size: 18px; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); position: relative; overflow: hidden;">
              📧
            </a>
            <a href="https://github.com/JEROLD-creator653" target="_blank" rel="noopener noreferrer" class="footer-social-link github" title="GitHub" aria-label="GitHub" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #f3f4f6, #e5e7eb); color: #1f2937; text-decoration: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); position: relative; overflow: hidden;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
            </a>
            <a href="https://linkedin.com/in/jerold-christoper-g-992052327" target="_blank" rel="noopener noreferrer" class="footer-social-link linkedin" title="LinkedIn" aria-label="LinkedIn" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; text-decoration: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); position: relative; overflow: hidden;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
            <a href="https://twitter.com/yourhandle" target="_blank" rel="noopener noreferrer" class="footer-social-link twitter" title="Twitter" aria-label="Twitter" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #dbeafe, #93c5fd); color: #1d4ed8; text-decoration: none; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); position: relative; overflow: hidden;">
              <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
            </a>
            <a href="https://lavender-shield.vercel.app/" target="_blank" rel="noopener noreferrer" class="footer-social-link website" title="Website" aria-label="Website" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #4338ca; text-decoration: none; font-size: 18px; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); position: relative; overflow: hidden;">
              🌐
            </a>
          </div>
        </div>
        <div style="color: #6b7280; font-size: 14px;">
          © 2026 UPI Fraud Detection System | All rights reserved | Powered by FDT2
        </div>
      </div>
    </div>
  </footer>

  <style>
    body.dark-mode footer {
      border-top-color: #334155 !important;
      background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.02)) !important;
    }

    body.dark-mode footer h3 {
      color: #e5e7eb !important;
    }

    body.dark-mode footer > div > div > div:last-child {
      color: #9ca3af !important;
    }

    .footer-social-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.5s ease;
      z-index: 1;
      pointer-events: none;
    }

    .footer-social-link:hover::before {
      left: 100%;
    }

    .footer-social-link:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
    }

    body.dark-mode .footer-social-link.email { background: linear-gradient(135deg, #7f1d1d, #991b1b) !important; color: #fecaca !important; }
    body.dark-mode .footer-social-link.github { background: linear-gradient(135deg, #1f2937, #374151) !important; color: #f3f4f6 !important; }
    body.dark-mode .footer-social-link.linkedin { background: linear-gradient(135deg, #1e40af, #2563eb) !important; color: #dbeafe !important; }
    body.dark-mode .footer-social-link.twitter { background: linear-gradient(135deg, #1e3a8a, #1d4ed8) !important; color: #bfdbfe !important; }
    body.dark-mode .footer-social-link.website { background: linear-gradient(135deg, #4338ca, #6366f1) !important; color: #e0e7ff !important; }
  </style>

</body>
</html>